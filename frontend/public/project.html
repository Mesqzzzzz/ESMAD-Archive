<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Projeto · ESMAD Academic Repository</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#F05A31",
              secondary: "#BBBCC1",
            },
          },
        },
      };
    </script>

    <style>
      .ring-soft {
        box-shadow: 0 0 0 1px rgba(17, 24, 39, 0.08);
      }
      .lc-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .lc-6 {
        display: -webkit-box;
        -webkit-line-clamp: 6;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>

  <body class="bg-white font-sans text-gray-900">
    <!-- Top bar -->
    <div class="border-b border-gray-100">
      <div
        class="mx-auto max-w-7xl px-4 py-2 flex items-center justify-between text-xs text-gray-600"
      >
        <div class="flex items-center gap-3">
          <span class="inline-flex items-center gap-2">
            <span class="h-2 w-2 rounded-full bg-primary"></span>
            Detalhe do Projeto
          </span>
          <span class="hidden sm:inline text-gray-300">|</span>
          <span class="hidden sm:inline">ESMAD · Politécnico do Porto</span>
        </div>

        <div class="hidden sm:flex items-center gap-4">
          <a href="index.html" class="hover:text-gray-900">Início</a>
          <a href="projects.html" class="hover:text-gray-900">Projetos</a>
          <a href="login.html" class="hover:text-gray-900">Login</a>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-gray-100"
    >
      <nav
        class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between"
      >
        <a href="index.html" class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-xl bg-primary/10 ring-soft flex items-center justify-center"
            aria-hidden="true"
          >
            <div class="h-5 w-5 rounded-md bg-primary"></div>
          </div>
          <div class="leading-tight">
            <div class="text-sm font-semibold tracking-wide text-gray-900">
              ESMAD Academic Repository
            </div>
            <div class="text-xs text-gray-500">
              Consulta institucional de projetos
            </div>
          </div>
        </a>

        <div class="flex items-center gap-3">
          <a
            id="backBtn"
            href="projects.html"
            class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
          >
            ← Voltar
          </a>

          <button
            id="downloadBtn"
            class="inline-flex items-center justify-center rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:opacity-90 transition disabled:opacity-60 disabled:cursor-not-allowed"
            disabled
            type="button"
          >
            Download
          </button>
        </div>
      </nav>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Main card -->
        <section class="lg:col-span-8">
          <article
            class="rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <div class="flex items-start justify-between gap-4">
              <div class="min-w-0">
                <div
                  class="inline-flex items-center gap-2 rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary ring-soft"
                >
                  <span class="h-1.5 w-1.5 rounded-full bg-primary"></span>
                  Projeto
                </div>

                <h1
                  id="title"
                  class="mt-4 text-2xl md:text-3xl font-semibold tracking-tight text-gray-900"
                >
                  (a carregar...)
                </h1>

                <p id="meta" class="mt-2 text-sm text-gray-600"></p>
              </div>

              <div
                class="shrink-0 h-11 w-11 rounded-2xl bg-primary/10 flex items-center justify-center"
                aria-hidden="true"
              >
                <div class="h-3 w-3 rounded-sm bg-primary"></div>
              </div>
            </div>

            <div class="mt-6 border-t border-gray-100 pt-5">
              <h2 class="text-sm font-semibold text-gray-900">Descrição</h2>
              <p
                id="description"
                class="mt-2 text-sm text-gray-700 whitespace-pre-wrap leading-relaxed"
              ></p>
            </div>

            <div class="mt-6 flex flex-wrap gap-3">
              <a
                id="repoBtn"
                href="#"
                target="_blank"
                rel="noreferrer"
                class="hidden inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
              >
                Repo
              </a>

              <a
                id="demoBtn"
                href="#"
                target="_blank"
                rel="noreferrer"
                class="hidden inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
              >
                Demo
              </a>

              <span
                id="fileBadge"
                class="hidden inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-700"
              ></span>
            </div>

            <!-- Status -->
            <div
              id="statusWrap"
              class="mt-6 rounded-2xl border border-gray-100 bg-gray-50 p-4 ring-soft"
            >
              <p class="text-xs font-semibold text-gray-700">Estado</p>
              <p
                id="status"
                class="mt-1 text-sm text-gray-700 whitespace-pre-wrap"
              ></p>
            </div>

            <!-- Debug -->
            <details class="mt-6">
              <summary
                class="cursor-pointer text-sm font-semibold text-gray-700"
              >
                Debug (JSON)
              </summary>
              <pre
                id="debug"
                class="mt-3 rounded-2xl border border-gray-100 bg-white p-4 text-xs overflow-auto ring-soft"
              ></pre>
            </details>
          </article>
        </section>

        <!-- Side info -->
        <aside class="lg:col-span-4">
          <div
            class="rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <h3 class="text-sm font-semibold text-gray-900">
              Acesso e permissões
            </h3>
            <p class="mt-2 text-sm text-gray-600">
              A consulta é pública. Para descarregar anexos, é necessário login.
            </p>

            <div class="mt-5 space-y-3">
              <div class="rounded-xl border border-gray-100 bg-gray-50 p-4">
                <p class="text-xs text-gray-500">Sem login</p>
                <p class="mt-1 text-sm font-semibold text-gray-900">
                  Visualizar detalhes do projeto
                </p>
              </div>
              <div class="rounded-xl border border-gray-100 bg-gray-50 p-4">
                <p class="text-xs text-gray-500">Com login</p>
                <p class="mt-1 text-sm font-semibold text-gray-900">
                  Descarregar ficheiros e aceder a recursos
                </p>
              </div>
            </div>

            <a
              id="loginCta"
              href="login.html"
              class="mt-5 hidden w-full inline-flex items-center justify-center rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:opacity-90 transition"
            >
              Fazer login
            </a>

            <p class="mt-4 text-xs text-gray-500">
              Nota: se o projeto não tiver ficheiro associado, o download ficará
              indisponível.
            </p>
          </div>

          <!-- Notificações -->
          <div
            class="mt-6 rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <h3 class="text-sm font-semibold text-gray-900">Notificações</h3>
            <p class="mt-2 text-sm text-gray-600">
              Alertas surgem automaticamente quando existirem notificações por
              ler.
            </p>
            <p id="notifHint" class="mt-3 text-xs text-gray-500"></p>
          </div>
        </aside>
      </div>
    </main>

    <!-- Toast container -->
    <div
      id="toastWrap"
      class="fixed right-4 bottom-4 z-[9999] flex flex-col gap-3 pointer-events-none"
    ></div>

    <script>
      // ==========================
      // CONFIG
      // ==========================
      const API_BASE = window.location.origin; // ex: http://localhost:8080
      const GRAPHQL_URL = `${API_BASE}/graphql`;

      // ==========================
      // UI HELPERS
      // ==========================
      function setStatus(msg) {
        document.getElementById("status").textContent = msg || "";
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function getToken() {
        return localStorage.getItem("token");
      }

      // devolve Int (valida)
      function getProjectIdInt() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get("id");
        const id = Number(raw);
        if (!raw || !Number.isFinite(id)) return { raw, id: null };
        return { raw, id };
      }

      async function gql(query, variables = {}) {
        const token = getToken();
        const res = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ query, variables }),
        });

        const text = await res.text().catch(() => "");
        let json;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          console.error("Resposta não-JSON:", res.status, text);
          throw new Error(`Backend não devolveu JSON (HTTP ${res.status})`);
        }

        if (!res.ok) {
          const msg =
            json?.errors?.[0]?.message ||
            json?.message ||
            json?.error ||
            text ||
            `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (json?.errors?.length) {
          throw new Error(json.errors[0].message || "Erro GraphQL");
        }

        return json.data;
      }

      // ==========================
      // DATA FETCHING
      // ==========================
      async function fetchProject(id) {
        const data = await gql(
          `
          query ($id: Int!) {
            project(id: $id) {
              id
              title
              description
              repoUrl
              demoUrl
              createdAt
              fileId
            }
          }
        `,
          { id },
        );
        return data.project;
      }

      async function fetchDownloadUrl(fileId) {
        const token = getToken();
        if (!token) throw new Error("Faz login para descarregar.");

        const res = await fetch(
          `${API_BASE}/files/${encodeURIComponent(fileId)}/download`,
          { method: "GET", headers: { Authorization: `Bearer ${token}` } },
        );

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(
            `Erro no download (${res.status}): ${txt || "sem detalhe"}`,
          );
        }

        const json = await res.json();
        if (!json.downloadUrl)
          throw new Error("Resposta inválida: falta downloadUrl");
        return json.downloadUrl;
      }

      // ==========================
      // NOTIFICATIONS (Toast)
      // ==========================
      const toastWrap = document.getElementById("toastWrap");
      const notifHint = document.getElementById("notifHint");
      let notifTimer = null;
      let lastShownNotificationId = null;

      function safeDate(v) {
        try {
          const d = new Date(v);
          if (Number.isNaN(d.getTime())) return "";
          return d.toLocaleString("pt-PT");
        } catch {
          return "";
        }
      }

      function pickMessage(n) {
        return (
          n.message ||
          n.text ||
          n.title ||
          n.body ||
          n.type ||
          n.event ||
          `Tens uma nova notificação (id=${n.id})`
        );
      }

      function removeToast(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      async function markNotificationRead(id) {
        const token = getToken();
        if (!token) return;

        try {
          // Se o teu gateway servir frontend+api no mesmo origin, relativo está OK.
          // Se precisares, troca para: `${API_BASE}/notifications/${id}/read`
          const res = await fetch(`/notifications/${id}/read`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });
          if (!res.ok) {
            const t = await res.text().catch(() => "");
            console.warn("mark read failed:", res.status, t);
          }
        } catch (e) {
          console.warn("mark read error:", e);
        }
      }

      function showToastForNotification(n) {
        if (!n || !n.id) return;
        if (String(n.id) === String(lastShownNotificationId)) return;
        lastShownNotificationId = String(n.id);

        const toastId = `toast_${n.id}`;
        const createdAt =
          n.createdAt || n.created_at || n.at || n.timestamp || null;
        const msg = pickMessage(n);

        const el = document.createElement("div");
        el.id = toastId;
        el.className =
          "pointer-events-auto w-[min(420px,calc(100vw-2rem))] rounded-2xl bg-gray-950 text-white border border-white/10 shadow-2xl p-4";

        el.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm font-semibold">Nova notificação ✅</p>
              <p class="mt-2 text-sm text-white/90 whitespace-pre-wrap">${escapeHtml(msg)}</p>

              <div class="mt-3 flex items-center justify-between gap-4 text-xs text-white/60">
                <span>${createdAt ? safeDate(createdAt) : ""}</span>
                <span>#${escapeHtml(String(n.id))}</span>
              </div>

              <div class="mt-4 flex gap-2 justify-end">
                <button class="rounded-xl bg-white/10 px-3 py-2 text-sm font-semibold hover:bg-white/15 transition" data-action="dismiss">
                  Ignorar
                </button>
                <button class="rounded-xl bg-primary px-3 py-2 text-sm font-semibold hover:opacity-90 transition" data-action="ok">
                  OK
                </button>
              </div>
            </div>

            <button class="rounded-xl px-2 py-1 text-white/80 hover:text-white transition" aria-label="Fechar" data-action="close">
              ×
            </button>
          </div>
        `;

        el.addEventListener("click", async (ev) => {
          const btn = ev.target?.closest?.("[data-action]");
          if (!btn) return;
          removeToast(toastId);
          await markNotificationRead(n.id);
        });

        toastWrap.appendChild(el);

        setTimeout(async () => {
          const stillThere = document.getElementById(toastId);
          if (stillThere) {
            stillThere.remove();
            await markNotificationRead(n.id);
          }
        }, 7000);
      }

      async function fetchUnreadNotifications(limit = 1) {
        const token = getToken();
        if (!token) return [];

        const url = `/notifications/?unread=true&limit=${encodeURIComponent(limit)}&offset=0`;

        const res = await fetch(url, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) {
          const t = await res.text().catch(() => "");
          console.warn("notifications fetch failed:", res.status, t);
          return [];
        }

        const json = await res.json().catch(() => null);
        if (Array.isArray(json)) return json;

        const items =
          json?.items ||
          json?.data ||
          json?.notifications ||
          json?.rows ||
          json?.result;

        return Array.isArray(items) ? items : [];
      }

      async function checkNotificationsOnce() {
        try {
          const items = await fetchUnreadNotifications(1);
          if (items.length > 0) showToastForNotification(items[0]);
        } catch (e) {
          console.warn("checkNotificationsOnce error:", e);
        }
      }

      function startNotificationsPolling() {
        if (!getToken()) {
          notifHint.textContent =
            "Faz login para receberes alertas de notificações.";
          return;
        }
        notifHint.textContent = "A monitorizar notificações (polling).";

        checkNotificationsOnce();
        if (notifTimer) clearInterval(notifTimer);
        notifTimer = setInterval(checkNotificationsOnce, 3000);
      }

      // ==========================
      // INIT
      // ==========================
      document.addEventListener("DOMContentLoaded", async () => {
        const { raw, id } = getProjectIdInt();
        const downloadBtn = document.getElementById("downloadBtn");
        const loginCta = document.getElementById("loginCta");

        if (!getToken()) loginCta.classList.remove("hidden");

        // start notifications
        startNotificationsPolling();

        if (!id) {
          setStatus(`Falta ?id=... (valor atual: ${raw || "null"})`);
          downloadBtn.disabled = true;
          downloadBtn.textContent = "Download";
          return;
        }

        setStatus("A carregar projeto...");

        try {
          const p = await fetchProject(id);

          if (!p) {
            setStatus("Projeto não encontrado.");
            return;
          }

          document.getElementById("title").textContent = p.title || "Projeto";
          document.getElementById("description").textContent =
            p.description || "";
          document.getElementById("meta").textContent =
            `ID: ${p.id} • Criado: ${
              p.createdAt ? new Date(p.createdAt).toLocaleString("pt-PT") : "-"
            }`;

          document.getElementById("debug").textContent = JSON.stringify(
            { urlIdRaw: raw, urlIdInt: id, project: p },
            null,
            2,
          );

          // Repo/Demo
          if (p.repoUrl) {
            const btn = document.getElementById("repoBtn");
            btn.href = p.repoUrl;
            btn.classList.remove("hidden");
          }
          if (p.demoUrl) {
            const btn = document.getElementById("demoBtn");
            btn.href = p.demoUrl;
            btn.classList.remove("hidden");
          }

          // File badge
          const fileBadge = document.getElementById("fileBadge");
          if (p.fileId) {
            fileBadge.textContent = `Ficheiro: ${p.fileId}`;
            fileBadge.classList.remove("hidden");
          }

          // Download
          if (!p.fileId) {
            downloadBtn.disabled = true;
            downloadBtn.textContent = "Sem ficheiro";
            setStatus("Este projeto não tem ficheiro associado.");
            return;
          }

          downloadBtn.disabled = false;
          downloadBtn.textContent = "Download";

          downloadBtn.addEventListener("click", async () => {
            try {
              setStatus("A gerar link de download...");
              downloadBtn.disabled = true;

              const url = await fetchDownloadUrl(p.fileId);

              setStatus("A abrir download...");
              window.open(url, "_blank", "noopener,noreferrer");
            } catch (e) {
              console.error(e);
              setStatus(e.message || "Erro ao descarregar");
            } finally {
              downloadBtn.disabled = false;
            }
          });

          setStatus("Pronto.");
        } catch (err) {
          console.error(err);
          setStatus(err.message || "Erro a carregar projeto");
        }
      });
    </script>
  </body>
</html>
