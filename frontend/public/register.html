<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registo · ESMAD Academic Repository</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#F05A31",
              secondary: "#BBBCC1",
            },
          },
        },
      };
    </script>

    <style>
      .ring-soft {
        box-shadow: 0 0 0 1px rgba(17, 24, 39, 0.08);
      }
    </style>
  </head>

  <body class="bg-white font-sans text-gray-900 min-h-screen">
    <!-- Top bar -->
    <div class="border-b border-gray-100">
      <div
        class="mx-auto max-w-7xl px-4 py-2 flex items-center justify-between text-xs text-gray-600"
      >
        <div class="flex items-center gap-2">
          <span class="h-2 w-2 rounded-full bg-primary"></span>
          <span>ESMAD · Politécnico do Porto</span>
        </div>
        <a href="index.html" class="hover:text-gray-900">Início</a>
      </div>
    </div>

    <main class="flex items-center justify-center px-4 py-12">
      <div class="w-full max-w-md">
        <div class="rounded-2xl border border-gray-100 bg-white p-8 ring-soft">
          <!-- Header -->
          <div class="text-center">
            <div
              class="mx-auto h-12 w-12 rounded-2xl bg-primary/10 flex items-center justify-center"
              aria-hidden="true"
            >
              <div class="h-5 w-5 rounded-md bg-primary"></div>
            </div>

            <h1
              class="mt-4 text-2xl font-semibold tracking-tight text-gray-900"
            >
              Criar conta
            </h1>
            <p class="mt-1 text-sm text-gray-600">
              Registo para acesso e submissões no repositório
            </p>
          </div>

          <!-- Form -->
          <form id="registerForm" class="mt-6 space-y-5" novalidate>
            <div>
              <label
                for="name"
                class="block text-sm font-semibold text-gray-700"
              >
                Nome
              </label>
              <input
                type="text"
                id="name"
                placeholder="O teu nome"
                class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                autocomplete="name"
              />
              <p id="nameHint" class="mt-2 text-xs text-gray-500 hidden"></p>
            </div>

            <div>
              <label
                for="email"
                class="block text-sm font-semibold text-gray-700"
              >
                Email
              </label>
              <input
                type="email"
                id="email"
                placeholder="email@exemplo.com"
                class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                autocomplete="email"
              />
              <p id="emailHint" class="mt-2 text-xs text-gray-500 hidden"></p>
            </div>

            <div>
              <div class="flex items-center justify-between">
                <label
                  for="password"
                  class="block text-sm font-semibold text-gray-700"
                >
                  Password
                </label>

                <button
                  id="togglePwdBtn"
                  type="button"
                  class="text-xs font-semibold text-gray-600 hover:text-gray-900"
                >
                  Mostrar
                </button>
              </div>

              <input
                type="password"
                id="password"
                placeholder="••••••••"
                class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                autocomplete="new-password"
              />

              <div class="mt-3 space-y-2">
                <p id="pwdHint" class="text-xs text-gray-500">
                  Recomendado: mínimo 8 caracteres.
                </p>

                <!-- Strength meter -->
                <div class="rounded-full bg-gray-100 h-2 overflow-hidden">
                  <div
                    id="pwdBar"
                    class="h-2 w-0 bg-primary transition-all"
                  ></div>
                </div>

                <p id="pwdStatus" class="text-xs text-gray-600"></p>
              </div>
            </div>

            <div>
              <div class="flex items-center justify-between">
                <label
                  for="confirmPassword"
                  class="block text-sm font-semibold text-gray-700"
                >
                  Confirmar password
                </label>

                <button
                  id="toggleConfirmBtn"
                  type="button"
                  class="text-xs font-semibold text-gray-600 hover:text-gray-900"
                >
                  Mostrar
                </button>
              </div>

              <input
                type="password"
                id="confirmPassword"
                placeholder="••••••••"
                class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                autocomplete="new-password"
              />

              <p id="confirmHint" class="mt-2 text-xs hidden"></p>
            </div>

            <!-- Error -->
            <div
              id="errorMsg"
              class="hidden rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
            >
              Erro no registo.
            </div>

            <!-- Submit -->
            <button
              id="submitBtn"
              type="submit"
              class="w-full inline-flex items-center justify-center rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:opacity-90 transition disabled:opacity-60 disabled:cursor-not-allowed"
            >
              Registar
            </button>
          </form>

          <p class="mt-6 text-center text-sm text-gray-600">
            Já tens conta?
            <a
              href="login.html"
              class="font-semibold text-primary hover:underline"
            >
              Fazer login
            </a>
          </p>
        </div>

        <p class="mt-6 text-center text-xs text-gray-500">
          Ao criar conta, poderás submeter projetos e descarregar ficheiros
          associados.
        </p>
      </div>
    </main>

    <script>
      const API_BASE = window.location.origin;
      const REGISTER_URL = `${API_BASE}/auth/register`;

      const registerForm = document.getElementById("registerForm");
      const errorMsg = document.getElementById("errorMsg");
      const submitBtn = document.getElementById("submitBtn");

      const nameInput = document.getElementById("name");
      const emailInput = document.getElementById("email");
      const pwdInput = document.getElementById("password");
      const confirmInput = document.getElementById("confirmPassword");

      const nameHint = document.getElementById("nameHint");
      const emailHint = document.getElementById("emailHint");
      const pwdBar = document.getElementById("pwdBar");
      const pwdStatus = document.getElementById("pwdStatus");
      const confirmHint = document.getElementById("confirmHint");

      const togglePwdBtn = document.getElementById("togglePwdBtn");
      const toggleConfirmBtn = document.getElementById("toggleConfirmBtn");

      function showHint(el, msg, tone = "muted") {
        el.textContent = msg || "";
        el.classList.remove("hidden");
        el.classList.remove("text-gray-500", "text-red-600", "text-green-700");

        if (tone === "error") el.classList.add("text-red-600");
        else if (tone === "ok") el.classList.add("text-green-700");
        else el.classList.add("text-gray-500");
      }

      function hideHint(el) {
        el.classList.add("hidden");
        el.textContent = "";
      }

      function setInputError(input, isError) {
        input.classList.toggle("border-red-300", isError);
        input.classList.toggle("focus:border-red-400", isError);
        input.classList.toggle("focus:ring-red-200", isError);

        if (!isError) {
          input.classList.remove(
            "border-red-300",
            "focus:border-red-400",
            "focus:ring-red-200",
          );
        }
      }

      function isValidEmail(email) {
        // simples e suficiente para UI; backend valida a sério
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function scorePassword(pwd) {
        let score = 0;
        const p = pwd || "";

        if (p.length >= 8) score++;
        if (p.length >= 12) score++;
        if (/[A-Z]/.test(p)) score++;
        if (/[0-9]/.test(p)) score++;
        if (/[^A-Za-z0-9]/.test(p)) score++;

        // score: 0..5
        return score;
      }

      function updatePasswordUI() {
        const pwd = pwdInput.value || "";
        const score = scorePassword(pwd);

        // barra: 0, 20, 40, 60, 80, 100
        const pct = Math.min(100, score * 20);
        pwdBar.style.width = pct + "%";

        if (!pwd) {
          pwdStatus.textContent = "";
          return;
        }

        if (pwd.length < 8) {
          pwdStatus.textContent =
            "Password curta. Usa pelo menos 8 caracteres.";
        } else if (score <= 2) {
          pwdStatus.textContent = "Força: básica.";
        } else if (score <= 4) {
          pwdStatus.textContent = "Força: razoável.";
        } else {
          pwdStatus.textContent = "Força: forte.";
        }
      }

      function updateConfirmUI() {
        const pwd = pwdInput.value || "";
        const confirm = confirmInput.value || "";

        if (!confirm) {
          hideHint(confirmHint);
          setInputError(confirmInput, false);
          return;
        }

        if (pwd === confirm) {
          showHint(confirmHint, "Passwords coincidem.", "ok");
          setInputError(confirmInput, false);
        } else {
          showHint(confirmHint, "As passwords não coincidem.", "error");
          setInputError(confirmInput, true);
        }
      }

      function togglePassword(input, btn) {
        const isPwd = input.type === "password";
        input.type = isPwd ? "text" : "password";
        btn.textContent = isPwd ? "Ocultar" : "Mostrar";
      }

      togglePwdBtn.addEventListener("click", () =>
        togglePassword(pwdInput, togglePwdBtn),
      );
      toggleConfirmBtn.addEventListener("click", () =>
        togglePassword(confirmInput, toggleConfirmBtn),
      );

      // Live validation
      pwdInput.addEventListener("input", () => {
        updatePasswordUI();
        updateConfirmUI();
      });

      confirmInput.addEventListener("input", updateConfirmUI);

      emailInput.addEventListener("blur", () => {
        const email = emailInput.value.trim();
        if (!email) {
          hideHint(emailHint);
          setInputError(emailInput, false);
          return;
        }
        if (!isValidEmail(email)) {
          showHint(emailHint, "Formato de email inválido.", "error");
          setInputError(emailInput, true);
        } else {
          hideHint(emailHint);
          setInputError(emailInput, false);
        }
      });

      nameInput.addEventListener("blur", () => {
        const name = nameInput.value.trim();
        if (!name) {
          showHint(nameHint, "O nome é obrigatório.", "error");
          setInputError(nameInput, true);
        } else {
          hideHint(nameHint);
          setInputError(nameInput, false);
        }
      });

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg.classList.add("hidden");

        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const password = pwdInput.value.trim();
        const confirmPassword = confirmInput.value.trim();

        // Reset errors
        setInputError(nameInput, false);
        setInputError(emailInput, false);
        setInputError(pwdInput, false);
        setInputError(confirmInput, false);

        // Client-side checks
        let hasError = false;

        if (!name) {
          showHint(nameHint, "O nome é obrigatório.", "error");
          setInputError(nameInput, true);
          hasError = true;
        } else {
          hideHint(nameHint);
        }

        if (!email) {
          showHint(emailHint, "O email é obrigatório.", "error");
          setInputError(emailInput, true);
          hasError = true;
        } else if (!isValidEmail(email)) {
          showHint(emailHint, "Formato de email inválido.", "error");
          setInputError(emailInput, true);
          hasError = true;
        } else {
          hideHint(emailHint);
        }

        if (!password) {
          pwdStatus.textContent = "A password é obrigatória.";
          setInputError(pwdInput, true);
          hasError = true;
        } else if (password.length < 8) {
          pwdStatus.textContent =
            "A password deve ter pelo menos 8 caracteres.";
          setInputError(pwdInput, true);
          hasError = true;
        }

        if (!confirmPassword) {
          showHint(confirmHint, "Confirma a password.", "error");
          setInputError(confirmInput, true);
          hasError = true;
        } else if (password !== confirmPassword) {
          showHint(confirmHint, "As passwords não coincidem.", "error");
          setInputError(confirmInput, true);
          hasError = true;
        }

        if (hasError) {
          errorMsg.textContent = "Corrige os campos assinalados.";
          errorMsg.classList.remove("hidden");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "A criar conta...";

        try {
          const response = await fetch(REGISTER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password }),
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(data.error || "Não foi possível criar conta");
          }

          localStorage.setItem("token", data.token);
          localStorage.setItem("user", JSON.stringify(data.user));

          window.location.href = "projects.html";
        } catch (err) {
          errorMsg.textContent = err.message || "Erro no registo";
          errorMsg.classList.remove("hidden");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Registar";
        }
      });

      // init UI
      updatePasswordUI();
      updateConfirmUI();
    </script>
  </body>
</html>
