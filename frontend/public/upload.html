<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload · ESMAD Academic Repository</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#F05A31",
              secondary: "#BBBCC1",
            },
          },
        },
      };
    </script>

    <style>
      .ring-soft {
        box-shadow: 0 0 0 1px rgba(17, 24, 39, 0.08);
      }
      .lc-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>

  <body class="bg-white font-sans text-gray-900 min-h-screen">
    <!-- Top bar -->
    <div class="border-b border-gray-100">
      <div
        class="mx-auto max-w-7xl px-4 py-2 flex items-center justify-between text-xs text-gray-600"
      >
        <div class="flex items-center gap-2">
          <span class="h-2 w-2 rounded-full bg-primary"></span>
          <span>Upload de Projeto</span>
          <span class="hidden sm:inline text-gray-300">|</span>
          <span class="hidden sm:inline">ESMAD · Politécnico do Porto</span>
        </div>
        <a href="projects.html" class="hover:text-gray-900">Projetos</a>
      </div>
    </div>

    <!-- Header -->
    <header
      class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-gray-100"
    >
      <nav
        class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between"
      >
        <a href="index.html" class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-xl bg-primary/10 ring-soft flex items-center justify-center"
            aria-hidden="true"
          >
            <div class="h-5 w-5 rounded-md bg-primary"></div>
          </div>
          <div class="leading-tight">
            <div class="text-sm font-semibold tracking-wide text-gray-900">
              ESMAD Academic Repository
            </div>
            <div class="text-xs text-gray-500">
              Criar projeto e anexar ficheiro
            </div>
          </div>
        </a>

        <div class="flex items-center gap-3">
          <a
            href="projects.html"
            class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
          >
            ← Voltar
          </a>
        </div>
      </nav>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Form -->
        <section class="lg:col-span-8">
          <div
            class="rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <div class="flex items-start justify-between gap-4">
              <div class="min-w-0">
                <div
                  class="inline-flex items-center gap-2 rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary ring-soft"
                >
                  <span class="h-1.5 w-1.5 rounded-full bg-primary"></span>
                  Upload
                </div>
                <h1
                  class="mt-4 text-2xl font-semibold tracking-tight text-gray-900"
                >
                  Criar projeto + anexar ficheiro
                </h1>
                <p class="mt-2 text-sm text-gray-600">
                  Fluxo: <span class="font-semibold">init</span> →
                  <span class="font-semibold">PUT</span> para storage →
                  <span class="font-semibold">complete</span> →
                  <span class="font-semibold">createProject</span>
                </p>
              </div>

              <div
                class="shrink-0 h-11 w-11 rounded-2xl bg-primary/10 flex items-center justify-center"
                aria-hidden="true"
              >
                <div class="h-3 w-3 rounded-sm bg-primary"></div>
              </div>
            </div>

            <form id="uploadForm" class="mt-6 space-y-6" novalidate>
              <!-- Row 1 -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    for="title"
                    class="block text-sm font-semibold text-gray-700"
                  >
                    Título <span class="text-red-600">*</span>
                  </label>
                  <input
                    id="title"
                    name="title"
                    placeholder="Ex: Sistema de Monitorização de Salas"
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                    required
                  />
                  <p
                    id="titleHint"
                    class="mt-2 text-xs text-gray-500 hidden"
                  ></p>
                </div>

                <div>
                  <label
                    for="visibility"
                    class="block text-sm font-semibold text-gray-700"
                  >
                    Visibilidade
                  </label>
                  <select
                    id="visibility"
                    name="visibility"
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm outline-none"
                    disabled
                  >
                    <option value="PUBLIC" selected>Público (por agora)</option>
                  </select>
                  <p class="mt-2 text-xs text-gray-500">
                    (Configuração futura — atualmente apenas público.)
                  </p>
                </div>
              </div>

              <!-- Description -->
              <div>
                <label
                  for="description"
                  class="block text-sm font-semibold text-gray-700"
                >
                  Descrição
                </label>
                <textarea
                  id="description"
                  name="description"
                  placeholder="Resumo do projeto, stack, objetivos..."
                  class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 min-h-[130px] resize-y"
                ></textarea>
              </div>

              <!-- Repo/Demo -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    for="repoUrl"
                    class="block text-sm font-semibold text-gray-700"
                  >
                    Repo URL
                  </label>
                  <input
                    id="repoUrl"
                    name="repoUrl"
                    placeholder="https://github.com/..."
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                  />
                  <p
                    id="repoHint"
                    class="mt-2 text-xs text-gray-500 hidden"
                  ></p>
                </div>

                <div>
                  <label
                    for="demoUrl"
                    class="block text-sm font-semibold text-gray-700"
                  >
                    Demo URL
                  </label>
                  <input
                    id="demoUrl"
                    name="demoUrl"
                    placeholder="https://..."
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                  />
                  <p
                    id="demoHint"
                    class="mt-2 text-xs text-gray-500 hidden"
                  ></p>
                </div>
              </div>

              <!-- File -->
              <div>
                <label
                  for="file"
                  class="block text-sm font-semibold text-gray-700"
                >
                  Ficheiro do projeto <span class="text-red-600">*</span>
                </label>

                <div
                  class="mt-2 rounded-2xl border border-gray-100 bg-gray-50 p-4 ring-soft"
                >
                  <input
                    id="file"
                    name="file"
                    type="file"
                    accept=".pdf,.zip"
                    class="block w-full text-sm file:mr-4 file:rounded-xl file:border-0 file:bg-primary file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:opacity-90 transition"
                    required
                  />
                  <p class="mt-3 text-xs text-gray-600">
                    Tipos pretendidos: <span class="font-semibold">PDF</span> ou
                    <span class="font-semibold">ZIP</span>. (Validação final é
                    no backend.)
                  </p>

                  <p id="fileMeta" class="mt-2 text-xs text-gray-500"></p>
                  <p id="fileHint" class="mt-2 text-xs text-red-600 hidden"></p>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex flex-col sm:flex-row gap-3">
                <button
                  class="inline-flex items-center justify-center rounded-xl bg-primary px-5 py-3 text-sm font-semibold text-white hover:opacity-90 transition disabled:opacity-60 disabled:cursor-not-allowed"
                  id="submitBtn"
                  type="submit"
                >
                  Criar & Upload
                </button>

                <button
                  class="inline-flex items-center justify-center rounded-xl border border-gray-200 bg-white px-5 py-3 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition"
                  type="button"
                  id="cancelBtn"
                >
                  Cancelar
                </button>
              </div>

              <!-- Status -->
              <div
                id="statusArea"
                class="hidden rounded-2xl border border-gray-100 bg-white p-4 ring-soft"
              >
                <p class="text-xs font-semibold text-gray-700">Estado</p>
                <pre
                  id="status"
                  class="mt-2 text-xs text-gray-700 whitespace-pre-wrap"
                ></pre>
              </div>

              <!-- Error -->
              <div
                id="errorArea"
                class="hidden rounded-2xl border border-red-200 bg-red-50 p-4"
              >
                <p class="text-sm font-semibold text-red-800">Erro</p>
                <p id="errorText" class="mt-1 text-sm text-red-700"></p>
                <p class="mt-2 text-xs text-red-700">
                  Abre a consola (F12) para detalhes, se necessário.
                </p>
              </div>
            </form>
          </div>
        </section>

        <!-- Progress / Help -->
        <aside class="lg:col-span-4">
          <div
            class="rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <h2 class="text-sm font-semibold text-gray-900">Progresso</h2>
            <p class="mt-2 text-sm text-gray-600">
              O upload é feito em 4 etapas. Se falhar, a mensagem indica onde
              ocorreu.
            </p>

            <ol class="mt-5 space-y-3 text-sm">
              <li class="flex items-center justify-between gap-3">
                <span class="text-gray-700">1) init</span>
                <span id="step1" class="text-xs font-semibold text-gray-500"
                  >—</span
                >
              </li>
              <li class="flex items-center justify-between gap-3">
                <span class="text-gray-700">2) PUT (storage)</span>
                <span id="step2" class="text-xs font-semibold text-gray-500"
                  >—</span
                >
              </li>
              <li class="flex items-center justify-between gap-3">
                <span class="text-gray-700">3) complete</span>
                <span id="step3" class="text-xs font-semibold text-gray-500"
                  >—</span
                >
              </li>
              <li class="flex items-center justify-between gap-3">
                <span class="text-gray-700">4) createProject</span>
                <span id="step4" class="text-xs font-semibold text-gray-500"
                  >—</span
                >
              </li>
            </ol>

            <div class="mt-6 border-t border-gray-100 pt-5">
              <h3 class="text-sm font-semibold text-gray-900">Requisitos</h3>
              <ul class="mt-2 text-sm text-gray-600 space-y-2">
                <li>• Sessão ativa (token).</li>
                <li>• Ficheiro selecionado (PDF/ZIP).</li>
                <li>• Título obrigatório.</li>
              </ul>

              <p id="sessionHint" class="mt-4 text-xs text-gray-500"></p>

              <a
                id="loginCta"
                href="login.html"
                class="mt-4 hidden w-full inline-flex items-center justify-center rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:opacity-90 transition"
              >
                Fazer login
              </a>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <script>
      // ==========================
      // CONFIG
      // ==========================
      const API_BASE = window.location.origin; // ex: http://localhost:8080
      const GRAPHQL_URL = `${API_BASE}/graphql`;

      // ==========================
      // DOM
      // ==========================
      const uploadForm = document.getElementById("uploadForm");
      const submitBtn = document.getElementById("submitBtn");
      const cancelBtn = document.getElementById("cancelBtn");

      const statusArea = document.getElementById("statusArea");
      const statusEl = document.getElementById("status");
      const errorArea = document.getElementById("errorArea");
      const errorText = document.getElementById("errorText");

      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      const step3 = document.getElementById("step3");
      const step4 = document.getElementById("step4");

      const sessionHint = document.getElementById("sessionHint");
      const loginCta = document.getElementById("loginCta");

      const titleInput = document.getElementById("title");
      const titleHint = document.getElementById("titleHint");

      const repoUrlInput = document.getElementById("repoUrl");
      const demoUrlInput = document.getElementById("demoUrl");
      const repoHint = document.getElementById("repoHint");
      const demoHint = document.getElementById("demoHint");

      const fileInput = document.getElementById("file");
      const fileMeta = document.getElementById("fileMeta");
      const fileHint = document.getElementById("fileHint");

      // ==========================
      // HELPERS
      // ==========================
      function getToken() {
        return localStorage.getItem("token");
      }

      function setStatus(msg) {
        statusArea.classList.remove("hidden");
        statusEl.textContent = msg || "";
      }

      function clearStatus() {
        statusEl.textContent = "";
        statusArea.classList.add("hidden");
      }

      function setError(msg) {
        errorArea.classList.remove("hidden");
        errorText.textContent = msg || "Erro desconhecido";
      }

      function clearError() {
        errorArea.classList.add("hidden");
        errorText.textContent = "";
      }

      function resetSteps() {
        [step1, step2, step3, step4].forEach((el) => {
          el.textContent = "—";
          el.className = "text-xs font-semibold text-gray-500";
        });
      }

      function markStep(el, state) {
        // state: "doing" | "ok" | "err"
        if (state === "doing") {
          el.textContent = "Em curso…";
          el.className = "text-xs font-semibold text-gray-700";
        } else if (state === "ok") {
          el.textContent = "Concluído";
          el.className = "text-xs font-semibold text-green-700";
        } else {
          el.textContent = "Erro";
          el.className = "text-xs font-semibold text-red-700";
        }
      }

      function setInputError(input, hintEl, msg) {
        input.classList.add("border-red-300");
        input.classList.add("focus:border-red-400", "focus:ring-red-200");
        hintEl.textContent = msg;
        hintEl.classList.remove("hidden");
      }

      function clearInputError(input, hintEl) {
        input.classList.remove(
          "border-red-300",
          "focus:border-red-400",
          "focus:ring-red-200",
        );
        hintEl.textContent = "";
        hintEl.classList.add("hidden");
      }

      function isValidUrl(v) {
        if (!v) return true;
        try {
          const u = new URL(v);
          return u.protocol === "http:" || u.protocol === "https:";
        } catch {
          return false;
        }
      }

      async function postJson(url, body, token) {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify(body),
        });

        const text = await res.text().catch(() => "");
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {}

        if (!res.ok) {
          const msg =
            json?.detail || json?.error || text || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        return json;
      }

      async function gql(query, variables, token) {
        const res = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ query, variables }),
        });

        const text = await res.text().catch(() => "");
        let json = null;

        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          console.error("GraphQL non-JSON response:", res.status, text);
          throw new Error(`GraphQL: resposta não-JSON (HTTP ${res.status})`);
        }

        if (!res.ok) {
          console.error("GraphQL HTTP error:", res.status, json);
          const msg =
            json?.errors?.[0]?.message ||
            json?.message ||
            text ||
            `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (json?.errors?.length) {
          console.error("GraphQL errors full:", json.errors);

          const e0 = json.errors[0];
          const detail =
            e0?.extensions?.detail ||
            e0?.extensions?.response?.body?.detail ||
            e0?.extensions?.response?.body?.message ||
            e0?.extensions?.originalError?.message ||
            e0?.extensions?.exception?.message ||
            null;

          const toStr = (v) => {
            if (v == null) return "";
            if (typeof v === "string") return v;
            try {
              return JSON.stringify(v);
            } catch {
              return String(v);
            }
          };

          throw new Error(
            detail
              ? `${toStr(e0.message)} — ${toStr(detail)}`
              : toStr(e0.message) || "Erro GraphQL",
          );
        }

        return json.data;
      }

      function toPublicMinioUrl(url) {
        // Em swarm/gateway pode não ser "minio"; mantemos compatibilidade com dev
        try {
          const u = new URL(url);
          if (u.hostname === "minio") u.hostname = "localhost";
          return u.toString();
        } catch {
          return url;
        }
      }

      async function uploadToPresignedUrl(uploadUrl, file) {
        const publicUrl = toPublicMinioUrl(uploadUrl);
        const res = await fetch(publicUrl, {
          method: "PUT",
          headers: { "Content-Type": file.type || "application/octet-stream" },
          body: file,
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(
            `Falha no PUT para storage (${res.status}): ${txt || "sem detalhe"}`,
          );
        }
      }

      function bytesToHuman(bytes) {
        if (!Number.isFinite(bytes)) return "";
        const units = ["B", "KB", "MB", "GB"];
        let b = bytes;
        let i = 0;
        while (b >= 1024 && i < units.length - 1) {
          b /= 1024;
          i++;
        }
        return `${b.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
      }

      // ==========================
      // INIT UI
      // ==========================
      function refreshSessionUI() {
        const token = getToken();
        if (!token) {
          sessionHint.textContent =
            "Sessão: sem login (necessário para upload).";
          loginCta.classList.remove("hidden");
          submitBtn.disabled = false; // ainda deixa clicar, mas o handler bloqueia
        } else {
          sessionHint.textContent = "Sessão: ativa.";
          loginCta.classList.add("hidden");
        }
      }

      refreshSessionUI();
      resetSteps();

      cancelBtn.addEventListener("click", () => {
        window.location.href = "projects.html";
      });

      // file meta
      fileInput.addEventListener("change", () => {
        fileHint.classList.add("hidden");
        fileHint.textContent = "";
        const f = fileInput.files?.[0];
        if (!f) {
          fileMeta.textContent = "";
          return;
        }
        fileMeta.textContent = `${f.name} · ${bytesToHuman(f.size)} · ${f.type || "application/octet-stream"}`;
      });

      // basic validation on blur
      titleInput.addEventListener("blur", () => {
        const v = titleInput.value.trim();
        if (!v) setInputError(titleInput, titleHint, "O título é obrigatório.");
        else clearInputError(titleInput, titleHint);
      });

      function validateUrlField(input, hintEl, label) {
        const v = input.value.trim();
        if (!v) {
          clearInputError(input, hintEl);
          return true;
        }
        if (!isValidUrl(v)) {
          setInputError(
            input,
            hintEl,
            `${label}: URL inválido (usa http/https).`,
          );
          return false;
        }
        clearInputError(input, hintEl);
        return true;
      }

      repoUrlInput.addEventListener("blur", () =>
        validateUrlField(repoUrlInput, repoHint, "Repo URL"),
      );
      demoUrlInput.addEventListener("blur", () =>
        validateUrlField(demoUrlInput, demoHint, "Demo URL"),
      );

      // ==========================
      // SUBMIT
      // ==========================
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearError();
        clearStatus();
        resetSteps();

        const token = getToken();
        if (!token) {
          setError("Precisas de login para criar projeto (e para upload).");
          loginCta.classList.remove("hidden");
          return;
        }

        const title = titleInput.value.trim();
        const description = document.getElementById("description").value.trim();
        const repoUrl = repoUrlInput.value.trim();
        const demoUrl = demoUrlInput.value.trim();
        const file = fileInput.files?.[0];

        let ok = true;

        if (!title) {
          setInputError(titleInput, titleHint, "O título é obrigatório.");
          ok = false;
        } else {
          clearInputError(titleInput, titleHint);
        }

        ok = validateUrlField(repoUrlInput, repoHint, "Repo URL") && ok;
        ok = validateUrlField(demoUrlInput, demoHint, "Demo URL") && ok;

        if (!file) {
          fileHint.textContent = "Escolhe um ficheiro (PDF/ZIP).";
          fileHint.classList.remove("hidden");
          ok = false;
        }

        if (!ok) {
          setError("Corrige os campos assinalados.");
          return;
        }

        // inputs do projeto
        const inputBase = {
          title,
          description: description || null,
          repoUrl: repoUrl || null,
          demoUrl: demoUrl || null,
          coverImageUrl: null,
          ucIds: [],
          tags: [],
        };

        // prevent double-submit
        submitBtn.disabled = true;
        const prevText = submitBtn.textContent;
        submitBtn.textContent = "A enviar...";

        try {
          // 1) init
          markStep(step1, "doing");
          setStatus(
            `1/4 A iniciar upload...\nFicheiro: ${file.name} (${file.size} bytes)`,
          );

          const init = await postJson(
            `${API_BASE}/files/init`,
            {
              originalName: file.name,
              contentType: file.type || "application/octet-stream",
              sizeBytes: file.size,
            },
            token,
          );

          const fileId = init?.fileId;
          const uploadUrl = init?.uploadUrl;

          if (!fileId || !uploadUrl) {
            markStep(step1, "err");
            throw new Error(
              "Resposta inválida do /files/init (falta fileId/uploadUrl).",
            );
          }
          markStep(step1, "ok");

          // 2) PUT storage
          markStep(step2, "doing");
          setStatus(`2/4 A enviar para storage (PUT)...\nfileId: ${fileId}`);
          await uploadToPresignedUrl(uploadUrl, file);
          markStep(step2, "ok");

          // 3) complete
          markStep(step3, "doing");
          setStatus(`3/4 A finalizar upload...`);
          await postJson(
            `${API_BASE}/files/${encodeURIComponent(fileId)}/complete`,
            {},
            token,
          );
          markStep(step3, "ok");

          // 4) createProject
          markStep(step4, "doing");
          setStatus(`4/4 A criar projeto...`);

          const data = await gql(
            `
            mutation ($input: CreateProjectInput!) {
              createProject(input: $input) {
                id
                title
                fileId
              }
            }
            `,
            { input: { ...inputBase, fileId } },
            token,
          );

          const created = data?.createProject;
          if (!created?.id) {
            markStep(step4, "err");
            throw new Error("Projeto criado sem ID (resposta inesperada).");
          }
          markStep(step4, "ok");

          setStatus(
            `✅ Sucesso!\nProjeto: ${created.title}\nID: ${created.id}`,
          );
          window.location.href = `project.html?id=${encodeURIComponent(created.id)}`;
        } catch (err) {
          console.error(err);
          setError(err?.message || "Erro desconhecido");

          // marca step atual como erro se ainda estiver "—" ou "Em curso…"
          // (não tenta adivinhar; deixa os passos anteriores como estão)
          submitBtn.disabled = false;
          submitBtn.textContent = prevText;
        } finally {
          // se não redirecionou, repõe botão
          if (!window.location.href.includes("project.html")) {
            submitBtn.disabled = false;
            submitBtn.textContent = prevText;
          }
        }
      });
    </script>
  </body>
</html>
