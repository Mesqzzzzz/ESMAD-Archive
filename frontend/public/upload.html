<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload · ESMAD Academic Repository</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#F05A31",
              secondary: "#BBBCC1",
            },
          },
        },
      };
    </script>

    <style>
      .ring-soft {
        box-shadow: 0 0 0 1px rgba(17, 24, 39, 0.08);
      }
    </style>
  </head>

  <body class="bg-white font-sans text-gray-900 min-h-screen">
    <!-- Top bar -->
    <div class="border-b border-gray-100">
      <div
        class="mx-auto max-w-7xl px-4 py-2 flex items-center justify-between text-xs text-gray-600"
      >
        <div class="flex items-center gap-2">
          <span class="h-2 w-2 rounded-full bg-primary"></span>
          <span>Upload de Projeto</span>
          <span class="hidden sm:inline text-gray-300">|</span>
          <span class="hidden sm:inline">ESMAD · Politécnico do Porto</span>
        </div>
        <a href="projects.html" class="hover:text-gray-900">Projetos</a>
      </div>
    </div>

    <!-- Header -->
    <header
      class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-gray-100"
    >
      <nav
        class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between"
      >
        <a href="index.html" class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-xl bg-primary/10 ring-soft flex items-center justify-center"
            aria-hidden="true"
          >
            <div class="h-5 w-5 rounded-md bg-primary"></div>
          </div>
          <div class="leading-tight">
            <div class="text-sm font-semibold tracking-wide text-gray-900">
              ESMAD Academic Repository
            </div>
            <div class="text-xs text-gray-500">
              Criar projeto e anexar ficheiro
            </div>
          </div>
        </a>

        <div class="flex items-center gap-3">
          <a
            href="projects.html"
            class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
          >
            ← Voltar
          </a>
        </div>
      </nav>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Form -->
        <section class="lg:col-span-8">
          <div
            class="rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <div class="flex items-start justify-between gap-4">
              <div class="min-w-0">
                <div
                  class="inline-flex items-center gap-2 rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary ring-soft"
                >
                  <span class="h-1.5 w-1.5 rounded-full bg-primary"></span>
                  Upload
                </div>
                <h1
                  class="mt-4 text-2xl font-semibold tracking-tight text-gray-900"
                >
                  Criar projeto + anexar ficheiro
                </h1>
                <p class="mt-2 text-sm text-gray-600">
                  Fluxo: <span class="font-semibold">init</span> →
                  <span class="font-semibold">PUT</span> → complete →
                  <span class="font-semibold">createProject</span>
                </p>
              </div>

              <div
                class="shrink-0 h-11 w-11 rounded-2xl bg-primary/10 flex items-center justify-center"
                aria-hidden="true"
              >
                <div class="h-3 w-3 rounded-sm bg-primary"></div>
              </div>
            </div>

            <form id="uploadForm" class="mt-6 space-y-6" novalidate>
              <!-- Title / visibility -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700">
                    Título <span class="text-red-600">*</span>
                  </label>
                  <input
                    id="title"
                    placeholder="Ex: Sistema de Monitorização de Salas"
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                    required
                  />
                  <p
                    id="titleHint"
                    class="mt-2 text-xs text-red-600 hidden"
                  ></p>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700">
                    Visibilidade
                  </label>
                  <select
                    id="visibility"
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm outline-none"
                    disabled
                  >
                    <option value="PUBLIC" selected>Público (por agora)</option>
                  </select>
                  <p class="mt-2 text-xs text-gray-500">
                    (Configuração futura — atualmente apenas público.)
                  </p>
                </div>
              </div>

              <!-- ✅ Tipo/Curso/UC (sem anos) + 1 projeto = 1 UC -->
              <div
                class="rounded-2xl border border-gray-100 bg-gray-50 p-5 ring-soft"
              >
                <p class="text-sm font-semibold text-gray-900">
                  Associação académica (Tipo / Curso / UC)
                </p>
                <p class="mt-1 text-xs text-gray-600">
                  Seleciona <span class="font-semibold">1 UC</span> (1 projeto =
                  1 UC).
                </p>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs font-semibold text-gray-700">
                      Tipo de curso
                    </label>
                    <select
                      id="typeSelect"
                      class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-3 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                    >
                      <option value="">— Seleciona um tipo —</option>
                      <option value="CTESP">CTeSP</option>
                      <option value="Licenciatura">Licenciatura</option>
                      <option value="Mestrado">Mestrado</option>
                      <option value="Pós-Graduação">Pós-Graduação</option>
                    </select>
                    <p id="typeHint" class="mt-2 text-xs text-gray-500"></p>
                  </div>

                  <div>
                    <label class="block text-xs font-semibold text-gray-700">
                      Curso
                    </label>
                    <select
                      id="courseSelect"
                      class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-3 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                      disabled
                    >
                      <option value="">— Seleciona um tipo primeiro —</option>
                    </select>
                    <p id="courseHint" class="mt-2 text-xs text-gray-500"></p>
                  </div>

                  <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700">
                      Unidade Curricular
                    </label>

                    <div class="mt-2 flex flex-col sm:flex-row gap-3">
                      <select
                        id="ucSelect"
                        class="w-full rounded-xl border border-gray-200 bg-white px-3 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                        disabled
                      >
                        <option value="">— Seleciona curso primeiro —</option>
                      </select>

                      <button
                        id="addUcBtn"
                        type="button"
                        class="rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:opacity-90 transition disabled:opacity-60 disabled:cursor-not-allowed"
                        disabled
                      >
                        Selecionar
                      </button>
                    </div>

                    <div id="ucSelectedWrap" class="mt-4 hidden">
                      <p class="text-xs font-semibold text-gray-700">
                        UC selecionada
                      </p>
                      <div
                        id="ucSelectedList"
                        class="mt-2 flex flex-wrap gap-2"
                      ></div>
                    </div>

                    <p id="ucHint" class="mt-3 text-xs text-gray-500"></p>
                  </div>
                </div>
              </div>

              <!-- Description -->
              <div>
                <label class="block text-sm font-semibold text-gray-700">
                  Descrição
                </label>
                <textarea
                  id="description"
                  placeholder="Resumo do projeto, stack, objetivos..."
                  class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 min-h-[130px] resize-y"
                ></textarea>
              </div>

              <!-- Repo/Demo -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700">
                    Repo URL
                  </label>
                  <input
                    id="repoUrl"
                    placeholder="https://github.com/..."
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700">
                    Demo URL
                  </label>
                  <input
                    id="demoUrl"
                    placeholder="https://..."
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                  />
                </div>
              </div>

              <!-- File -->
              <div>
                <label class="block text-sm font-semibold text-gray-700">
                  Ficheiro do projeto <span class="text-red-600">*</span>
                </label>

                <div
                  class="mt-2 rounded-2xl border border-gray-100 bg-gray-50 p-4 ring-soft"
                >
                  <input
                    id="file"
                    type="file"
                    accept=".pdf,.zip"
                    class="block w-full text-sm file:mr-4 file:rounded-xl file:border-0 file:bg-primary file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:opacity-90 transition"
                    required
                  />
                  <p class="mt-3 text-xs text-gray-600">
                    Tipos pretendidos: <span class="font-semibold">PDF</span> ou
                    <span class="font-semibold">ZIP</span>.
                  </p>
                  <p id="fileHint" class="mt-2 text-xs text-red-600 hidden"></p>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex flex-col sm:flex-row gap-3">
                <button
                  id="submitBtn"
                  class="inline-flex items-center justify-center rounded-xl bg-primary px-5 py-3 text-sm font-semibold text-white hover:opacity-90 transition disabled:opacity-60 disabled:cursor-not-allowed"
                  type="submit"
                >
                  Criar & Upload
                </button>

                <button
                  id="cancelBtn"
                  class="inline-flex items-center justify-center rounded-xl border border-gray-200 bg-white px-5 py-3 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition"
                  type="button"
                >
                  Cancelar
                </button>
              </div>

              <!-- Status -->
              <div
                id="statusArea"
                class="hidden rounded-2xl border border-gray-100 bg-white p-4 ring-soft"
              >
                <p class="text-xs font-semibold text-gray-700">Estado</p>
                <pre
                  id="status"
                  class="mt-2 text-xs text-gray-700 whitespace-pre-wrap"
                ></pre>
              </div>

              <!-- Error -->
              <div
                id="errorArea"
                class="hidden rounded-2xl border border-red-200 bg-red-50 p-4"
              >
                <p class="text-sm font-semibold text-red-800">Erro</p>
                <p id="errorText" class="mt-1 text-sm text-red-700"></p>
              </div>
            </form>
          </div>
        </section>

        <!-- Help -->
        <aside class="lg:col-span-4">
          <div
            class="rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <h2 class="text-sm font-semibold text-gray-900">Requisitos</h2>
            <ul class="mt-3 text-sm text-gray-600 space-y-2">
              <li>• Sessão ativa (token).</li>
              <li>• Ficheiro selecionado (PDF/ZIP).</li>
              <li>• Título obrigatório.</li>
              <li>• 1 UC obrigatória.</li>
            </ul>

            <p id="sessionHint" class="mt-4 text-xs text-gray-500"></p>

            <a
              id="loginCta"
              href="login.html"
              class="mt-4 hidden w-full inline-flex items-center justify-center rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:opacity-90 transition"
            >
              Fazer login
            </a>
          </div>
        </aside>
      </div>
    </main>

    <script>
      // ==========================
      // CONFIG
      // ==========================
      const API_BASE = "http://localhost:3000";
      const GRAPHQL_URL = `${API_BASE}/graphql`;

      // ==========================
      // DOM
      // ==========================
      const uploadForm = document.getElementById("uploadForm");
      const submitBtn = document.getElementById("submitBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const statusArea = document.getElementById("statusArea");
      const statusEl = document.getElementById("status");
      const errorArea = document.getElementById("errorArea");
      const errorText = document.getElementById("errorText");

      const sessionHint = document.getElementById("sessionHint");
      const loginCta = document.getElementById("loginCta");

      const titleInput = document.getElementById("title");
      const titleHint = document.getElementById("titleHint");
      const fileInput = document.getElementById("file");
      const fileHint = document.getElementById("fileHint");

      const typeSelect = document.getElementById("typeSelect");
      const typeHint = document.getElementById("typeHint");

      const courseSelect = document.getElementById("courseSelect");
      const ucSelect = document.getElementById("ucSelect");
      const addUcBtn = document.getElementById("addUcBtn");

      const courseHint = document.getElementById("courseHint");
      const ucHint = document.getElementById("ucHint");

      const ucSelectedWrap = document.getElementById("ucSelectedWrap");
      const ucSelectedList = document.getElementById("ucSelectedList");

      // ==========================
      // STATE
      // ==========================
      let coursesCache = [];
      let ucsCache = [];
      let selectedUcId = ""; // ✅ 1 projeto = 1 UC

      // ==========================
      // HELPERS
      // ==========================
      function getToken() {
        return localStorage.getItem("token");
      }

      function setStatus(msg) {
        statusArea.classList.remove("hidden");
        statusEl.textContent = msg || "";
      }

      function clearStatus() {
        statusArea.classList.add("hidden");
        statusEl.textContent = "";
      }

      function setError(msg) {
        errorArea.classList.remove("hidden");
        errorText.textContent = msg || "Erro desconhecido";
      }

      function clearError() {
        errorArea.classList.add("hidden");
        errorText.textContent = "";
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function normalizeTypeForUI(type) {
        const t = String(type || "").trim();
        if (!t) return "";
        const up = t.toUpperCase();

        if (up === "CTESP") return "CTESP";
        if (up === "LICENCIATURA") return "Licenciatura";
        if (up === "MESTRADO") return "Mestrado";

        if (up === "PÓS-GRADUAÇÃO" || up === "POS-GRADUAÇÃO")
          return "Pós-Graduação";
        if (up === "POS-GRADUACAO" || up === "PÓS-GRADUACAO")
          return "Pós-Graduação";
        if (t === "Pós-Graduação") return "Pós-Graduação";

        return t;
      }

      async function gql(query, variables = {}) {
        const token = getToken();
        const res = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ query, variables }),
        });

        const text = await res.text().catch(() => "");
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          throw new Error(`GraphQL: resposta não-JSON (HTTP ${res.status})`);
        }

        if (!res.ok) {
          const msg =
            json?.errors?.[0]?.message ||
            json?.message ||
            text ||
            `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (json?.errors?.length) {
          throw new Error(json.errors[0].message || "Erro GraphQL");
        }

        return json.data;
      }

      async function postJson(url, body, token) {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify(body),
        });

        const text = await res.text().catch(() => "");
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {}

        if (!res.ok) {
          const msg =
            json?.detail || json?.error || text || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        return json;
      }

      async function uploadToPresignedUrl(uploadUrl, file) {
        const res = await fetch(uploadUrl, {
          method: "PUT",
          headers: { "Content-Type": file.type || "application/octet-stream" },
          body: file,
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(
            `Falha no PUT para storage (${res.status}): ${txt || "sem detalhe"}`,
          );
        }
      }

      // ==========================
      // COURSES / UCS UI
      // ==========================
      function resetCourseSelect() {
        courseSelect.disabled = true;
        courseSelect.innerHTML = `<option value="">— Seleciona um tipo primeiro —</option>`;
        courseHint.textContent = "";
        courseSelect.value = "";
      }

      function resetUcSelect() {
        ucSelect.disabled = true;
        addUcBtn.disabled = true;
        ucSelect.innerHTML = `<option value="">— Seleciona curso primeiro —</option>`;
        ucHint.textContent = "";
        ucSelect.value = "";

        selectedUcId = "";
        renderSelectedUc();
      }

      function renderCoursesForType(type) {
        courseSelect.innerHTML = `<option value="">— Seleciona um curso —</option>`;
        courseSelect.value = "";
        selectedUcId = "";
        renderSelectedUc();

        const list = coursesCache
          .filter((c) => normalizeTypeForUI(c.type) === type)
          .sort((a, b) => String(a.name).localeCompare(String(b.name), "pt"));

        if (!type) {
          resetCourseSelect();
          resetUcSelect();
          typeHint.textContent = "";
          return;
        }

        if (!list.length) {
          courseSelect.disabled = true;
          courseHint.textContent = "Sem cursos para este tipo (confirma seed).";
          resetUcSelect();
          return;
        }

        courseSelect.disabled = false;
        courseHint.textContent = `${list.length} curso(s) disponível(eis).`;

        for (const c of list) {
          const opt = document.createElement("option");
          opt.value = String(c.id);
          opt.textContent = c.name;
          courseSelect.appendChild(opt);
        }

        resetUcSelect();
      }

      function renderUcs() {
        ucSelect.innerHTML = "";

        if (!courseSelect.value) {
          resetUcSelect();
          return;
        }

        ucSelect.disabled = false;

        if (!ucsCache.length) {
          addUcBtn.disabled = true;
          ucSelect.innerHTML = `<option value="">— Sem UCs para este curso —</option>`;
          ucHint.textContent = "Sem UCs encontradas (confirma seed).";
          return;
        }

        addUcBtn.disabled = false;
        ucSelect.innerHTML = `<option value="">— Seleciona uma UC —</option>`;
        for (const u of ucsCache) {
          const opt = document.createElement("option");
          opt.value = String(u.id);
          opt.textContent = u.name;
          ucSelect.appendChild(opt);
        }

        ucHint.textContent = `${ucsCache.length} UC(s) encontrada(s).`;
      }

      function renderSelectedUc() {
        if (!selectedUcId) {
          ucSelectedWrap.classList.add("hidden");
          ucSelectedList.innerHTML = "";
          return;
        }

        ucSelectedWrap.classList.remove("hidden");
        const u = ucsCache.find((x) => String(x.id) === String(selectedUcId));
        const label = u ? u.name : `UC ${selectedUcId}`;

        ucSelectedList.innerHTML = `
          <span class="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-700">
            ${escapeHtml(label)}
            <button type="button" id="removeSelectedUcBtn" class="text-gray-400 hover:text-gray-900">×</button>
          </span>
        `;

        document
          .getElementById("removeSelectedUcBtn")
          ?.addEventListener("click", () => {
            selectedUcId = "";
            renderSelectedUc();
          });
      }

      async function loadCourses() {
        const data = await gql(`
          query {
            courses { id type name }
          }
        `);
        coursesCache = data?.courses || [];

        if (!coursesCache.length) {
          typeHint.textContent =
            "Sem cursos disponíveis (confirma seed na BD).";
        } else {
          typeHint.textContent = `${coursesCache.length} curso(s) carregado(s).`;
        }
      }

      async function loadUcs(courseId) {
        ucsCache = [];
        if (!courseId) {
          renderUcs();
          return;
        }

        // ✅ SEM year
        const data = await gql(
          `
          query($courseId: ID!, $search: String) {
            ucs(courseId: $courseId, search: $search) {
              id
              name
            }
          }
          `,
          { courseId: String(courseId), search: null },
        );

        ucsCache = data?.ucs || [];
        renderUcs();

        if (
          selectedUcId &&
          !ucsCache.some((u) => String(u.id) === String(selectedUcId))
        ) {
          selectedUcId = "";
        }
        renderSelectedUc();
      }

      // ==========================
      // SESSION UI
      // ==========================
      function refreshSessionUI() {
        const token = getToken();
        if (!token) {
          sessionHint.textContent =
            "Sessão: sem login (necessário para upload).";
          loginCta.classList.remove("hidden");
        } else {
          sessionHint.textContent = "Sessão: ativa.";
          loginCta.classList.add("hidden");
        }
      }

      refreshSessionUI();

      cancelBtn.addEventListener("click", () => {
        window.location.href = "projects.html";
      });

      titleInput.addEventListener("blur", () => {
        const v = titleInput.value.trim();
        if (!v) {
          titleHint.textContent = "O título é obrigatório.";
          titleHint.classList.remove("hidden");
        } else {
          titleHint.textContent = "";
          titleHint.classList.add("hidden");
        }
      });

      // ==========================
      // EVENTS (Tipo / Curso / UC)
      // ==========================
      typeSelect.addEventListener("change", async () => {
        const type = typeSelect.value || "";
        renderCoursesForType(type);
      });

      courseSelect.addEventListener("change", async () => {
        const courseId = courseSelect.value || "";
        selectedUcId = "";
        renderSelectedUc();
        await loadUcs(courseId);
      });

      // (opcional) se quiseres, permite "selecionar" a UC só por escolher no dropdown
      ucSelect.addEventListener("change", () => {
        // só atualiza UI do botão; a seleção final continua a ser via "Selecionar"
        // (mantém o teu fluxo atual)
      });

      addUcBtn.addEventListener("click", () => {
        const id = ucSelect.value;
        if (!id) return;

        selectedUcId = String(id);
        renderSelectedUc();
      });

      // ==========================
      // INIT load courses
      // ==========================
      (async function init() {
        try {
          resetCourseSelect();
          resetUcSelect();
          await loadCourses();
        } catch (e) {
          typeHint.textContent =
            "Erro ao carregar cursos/UCs. Vê consola (F12).";
          console.error(e);
        }
      })();

      // ==========================
      // SUBMIT
      // ==========================
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearError();
        clearStatus();

        const token = getToken();
        if (!token) {
          setError("Precisas de login para criar projeto (e para upload).");
          loginCta.classList.remove("hidden");
          return;
        }

        const title = titleInput.value.trim();
        const description = document.getElementById("description").value.trim();
        const repoUrl = document.getElementById("repoUrl").value.trim();
        const demoUrl = document.getElementById("demoUrl").value.trim();
        const file = fileInput.files?.[0];

        if (!title) {
          titleHint.textContent = "O título é obrigatório.";
          titleHint.classList.remove("hidden");
          setError("Corrige os campos assinalados.");
          return;
        }

        if (!file) {
          fileHint.textContent = "Escolhe um ficheiro (PDF/ZIP).";
          fileHint.classList.remove("hidden");
          setError("Corrige os campos assinalados.");
          return;
        }

        // 1 projeto = 1 UC (obrigatório)
        if (!selectedUcId) {
          setError("Seleciona 1 Unidade Curricular (1 projeto = 1 UC).");
          return;
        }

        // ✅ schema atual: ucId é SINGULAR
        const inputBase = {
          title,
          description: description || null,
          repoUrl: repoUrl || null,
          demoUrl: demoUrl || null,
          coverImageUrl: null,
          ucId: String(selectedUcId),
          tags: [],
        };

        submitBtn.disabled = true;
        const prevText = submitBtn.textContent;
        submitBtn.textContent = "A enviar...";

        try {
          // 1) init
          setStatus(`1/4 A iniciar upload...\nFicheiro: ${file.name}`);
          const init = await postJson(
            `${API_BASE}/files/init`,
            {
              originalName: file.name,
              contentType: file.type || "application/octet-stream",
              sizeBytes: file.size,
            },
            token,
          );

          const fileId = init?.fileId;
          const uploadUrl = init?.uploadUrl;
          if (!fileId || !uploadUrl)
            throw new Error("Resposta inválida do /files/init");

          // 2) PUT
          setStatus(`2/4 A enviar para storage (PUT)...\nfileId: ${fileId}`);
          await uploadToPresignedUrl(uploadUrl, file);

          // 3) complete
          setStatus(`3/4 A finalizar upload...`);
          await postJson(
            `${API_BASE}/files/${encodeURIComponent(fileId)}/complete`,
            {},
            token,
          );

          // 4) createProject
          setStatus(`4/4 A criar projeto...`);
          const data = await gql(
            `
            mutation ($input: CreateProjectInput!) {
              createProject(input: $input) {
                id
                title
                fileId
                ucId
              }
            }
            `,
            { input: { ...inputBase, fileId } },
          );

          const created = data?.createProject;
          if (!created?.id)
            throw new Error("Projeto criado sem ID (resposta inesperada).");

          setStatus(
            `✅ Sucesso!\nProjeto: ${created.title}\nID: ${created.id}\nUC: ${
              created.ucId || "-"
            }`,
          );

          window.location.href = `project.html?id=${encodeURIComponent(
            created.id,
          )}`;
        } catch (err) {
          console.error(err);
          setError(err?.message || "Erro desconhecido");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = prevText;
        }
      });
    </script>
  </body>
</html>
