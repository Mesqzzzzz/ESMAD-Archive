<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESMAD Academic Repository - Projetos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#F05A31",
              secondary: "#BBBCC1",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-white font-sans text-gray-800">
    <!-- Navbar -->
    <nav class="bg-white shadow-md">
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
      >
        <div class="text-2xl font-bold text-primary">ESMAD Repository</div>
        <div>
          <button
            id="logoutBtn"
            onclick="logout()"
            class="bg-primary text-white px-4 py-2 rounded-md hover:opacity-90 transition"
          >
            Logout
          </button>
        </div>
      </div>
    </nav>

    <p
      id="userInfo"
      class="max-w-7xl mx-auto px-4 pt-3 text-sm text-gray-600"
    ></p>

    <!-- Barra de pesquisa -->
    <section class="max-w-7xl mx-auto px-4 py-6">
      <input
        type="text"
        id="searchInput"
        class="w-full md:w-1/2 border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary"
        placeholder="Pesquisar projetos..."
      />
    </section>

    <!-- Tipos de curso -->
    <section class="max-w-7xl mx-auto px-4 py-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Tipos de Curso</h2>
      <div class="flex flex-wrap gap-4 mb-6">
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="CTESP"
        >
          CTESP
        </button>
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="Licenciatura"
        >
          Licenciatura
        </button>
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="Mestrado"
        >
          Mestrado
        </button>
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="Pos-Graduação"
        >
          Pós-Graduação
        </button>
      </div>

      <!-- Filtros de ano e UC -->
      <div id="filters" class="flex flex-wrap gap-4 mb-6 hidden">
        <select
          id="yearFilter"
          class="border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary"
        >
          <option value="">Todos os anos</option>
          <option value="1">1º Ano</option>
          <option value="2">2º Ano</option>
          <option value="3">3º Ano</option>
          <option value="4">4º Ano</option>
        </select>

        <select
          id="ucFilter"
          class="border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary"
        >
          <option value="">Todas as UCs</option>
          <!-- opções carregadas via GraphQL -->
        </select>
      </div>
    </section>

    <!-- Listagem de projetos -->
    <section class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
        <h2 class="text-2xl font-bold text-gray-900">Projetos</h2>
        <p id="resultsInfo" class="text-sm text-gray-600"></p>
      </div>

      <div
        id="projectsList"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
      ></div>
    </section>

    <script>
      // ===== CONFIG =====
      const GRAPHQL_URL = "http://localhost:3002/graphql";

      // ===== AUTH UI (mantém como tens) =====
      const token = localStorage.getItem("token");
      if (!token) window.location.href = "login.html";

      const user = JSON.parse(localStorage.getItem("user"));
      if (user)
        document.getElementById("userInfo").textContent = `Olá, ${user.name}`;

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }

      // ===== DOM =====
      const projectsList = document.getElementById("projectsList");
      const resultsInfo = document.getElementById("resultsInfo");
      const searchInput = document.getElementById("searchInput");
      const courseBtns = document.querySelectorAll(".course-btn");
      const filtersDiv = document.getElementById("filters");
      const yearFilter = document.getElementById("yearFilter");
      const ucFilter = document.getElementById("ucFilter");

      // ===== STATE =====
      let selectedCourseType = ""; // CTESP | Licenciatura | Mestrado | Pos-Graduação
      let selectedCourseId = ""; // vamos buscar o curso “principal” desse tipo (por agora)
      let selectedYear = "";
      let selectedUcId = "";
      let searchTerm = "";
      let latestCoursesCache = []; // cursos vindos do backend

      // ===== HELPERS =====
      async function gql(query, variables = {}) {
        const res = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            // para futuro: se o projects-service ler JWT, já está aqui
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ query, variables }),
        });

        const json = await res.json();
        if (json.errors?.length) {
          console.error(json.errors);
          throw new Error(json.errors[0].message || "Erro GraphQL");
        }
        return json.data;
      }

      function setLoading(message = "A carregar...") {
        projectsList.innerHTML = `<p class="text-gray-500 col-span-full">${message}</p>`;
      }

      function renderProjects(items, total) {
        projectsList.innerHTML = "";

        resultsInfo.textContent =
          typeof total === "number" ? `${total} resultado(s)` : "";

        if (!items || items.length === 0) {
          projectsList.innerHTML = `<p class="text-gray-500 col-span-full">Nenhum projeto encontrado.</p>`;
          return;
        }

        items.forEach((p) => {
          const card = document.createElement("div");
          card.className =
            "bg-secondary p-4 rounded-lg shadow-md hover:shadow-xl transition cursor-pointer";

          const tags = (p.tags || [])
            .slice(0, 6)
            .map((t) => `#${t}`)
            .join(" ");
          card.innerHTML = `
            <h3 class="text-lg font-bold text-primary mb-2">${escapeHtml(p.title)}</h3>
            <p class="text-sm text-gray-700 line-clamp-3 min-h-[3.5rem]">${escapeHtml(p.description || "")}</p>
            <div class="mt-3 text-xs text-gray-700">
              <p><span class="font-semibold">ID:</span> ${p.id}</p>
              <p><span class="font-semibold">Criado:</span> ${new Date(p.createdAt).toLocaleDateString("pt-PT")}</p>
              ${tags ? `<p class="mt-2">${escapeHtml(tags)}</p>` : ""}
            </div>
          `;

          // Para futuro (abrir detalhe):
          // card.addEventListener("click", () => window.location.href = `project.html?id=${p.id}`);
          projectsList.appendChild(card);
        });
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ===== DATA LOAD =====

      // 1) Carregar cursos (para mapear type -> courseId)
      async function loadCourses() {
        // Se o teu backend ainda não tiver courses/ucs, isto vai falhar.
        // Nesse caso, podes comentar esta função e ficar só com filtro por "tipo".
        const data = await gql(`
          query {
            courses {
              id
              type
              name
            }
          }
        `);

        latestCoursesCache = data.courses || [];
      }

      // Escolhe um courseId para um courseType.
      // Se no futuro tiveres vários cursos por tipo, aqui trocamos para dropdown de "curso".
      function pickCourseIdByType(type) {
        const candidates = latestCoursesCache.filter((c) => c.type === type);
        // estratégia simples: pega no primeiro
        return candidates.length ? candidates[0].id : "";
      }

      // 2) Carregar UCs com base em (courseId + year)
      async function loadUcsForFilters() {
        // limpa dropdown
        ucFilter.innerHTML = `<option value="">Todas as UCs</option>`;
        selectedUcId = "";
        ucFilter.value = "";

        if (!selectedCourseId) return;

        const variables = {
          courseId: selectedCourseId,
          year: selectedYear ? Number(selectedYear) : null,
          search: null,
        };

        const data = await gql(
          `
          query($courseId: ID, $year: Int, $search: String) {
            ucs(courseId: $courseId, year: $year, search: $search) {
              id
              name
              year
            }
          }
          `,
          variables,
        );

        const ucs = data.ucs || [];
        for (const u of ucs) {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = `${u.name}${u.year ? ` (Ano ${u.year})` : ""}`;
          ucFilter.appendChild(opt);
        }
      }

      // 3) Carregar projetos com filtros (GraphQL)
      async function loadProjects() {
        setLoading("A carregar projetos...");

        const filters = {
          search: searchTerm || null,
          courseId: selectedCourseId || null,
          year: selectedYear ? Number(selectedYear) : null,
          ucId: selectedUcId || null,
          tag: null,
        };

        const data = await gql(
          `
          query($filters: ProjectFiltersInput, $page: PaginationInput) {
            projects(filters: $filters, page: $page) {
              total
              items {
                id
                title
                description
                createdAt
                tags
                ucIds
              }
            }
          }
          `,
          { filters, page: { limit: 50, offset: 0 } },
        );

        renderProjects(data.projects.items, data.projects.total);
      }

      // ===== EVENTS =====

      // Tipo de curso
      courseBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          selectedCourseType = btn.dataset.course;

          // mostra filtros
          filtersDiv.classList.remove("hidden");

          // tenta mapear type -> courseId
          selectedCourseId = pickCourseIdByType(selectedCourseType);

          // refresca UCs e projetos
          try {
            await loadUcsForFilters();
          } catch (e) {
            console.warn(
              "Não foi possível carregar UCs (talvez ainda não exista seed):",
              e.message,
            );
          }

          await loadProjects();
        });
      });

      // Pesquisa
      let searchDebounce;
      searchInput.addEventListener("input", (e) => {
        searchTerm = e.target.value;
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
          loadProjects().catch((err) => setLoading(`Erro: ${err.message}`));
        }, 250);
      });

      // Ano
      yearFilter.addEventListener("change", async () => {
        selectedYear = yearFilter.value;

        try {
          await loadUcsForFilters();
        } catch (e) {
          console.warn("Não foi possível carregar UCs:", e.message);
        }

        await loadProjects();
      });

      // UC
      ucFilter.addEventListener("change", async () => {
        selectedUcId = ucFilter.value;
        await loadProjects();
      });

      // ===== INIT =====
      (async function init() {
        try {
          // cursos primeiro (para mapear tipos)
          await loadCourses();
        } catch (e) {
          console.warn(
            "Não foi possível carregar courses (talvez ainda não exista no backend):",
            e.message,
          );
        }

        // carrega projetos iniciais (sem filtros)
        await loadProjects();
      })().catch((err) => {
        console.error(err);
        setLoading(`Erro: ${err.message}`);
      });
    </script>
  </body>
</html>
