<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESMAD Academic Repository - Projetos</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#F05A31",
              secondary: "#BBBCC1",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-white font-sans text-gray-800">
    <!-- Navbar -->
    <nav class="bg-white shadow-md">
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between"
      >
        <div class="text-2xl font-bold text-primary">ESMAD Repository</div>

        <div class="flex items-center gap-3">
          <button
            id="createProjectBtn"
            class="bg-primary text-white px-4 py-2 rounded-md hover:opacity-90 transition"
          >
            Criar novo projeto
          </button>

          <button
            id="logoutBtn"
            class="bg-secondary text-gray-900 px-4 py-2 rounded-md hover:bg-gray-300 transition"
          >
            Logout
          </button>
        </div>
      </div>
    </nav>

    <p
      id="userInfo"
      class="max-w-7xl mx-auto px-4 pt-3 text-sm text-gray-600"
    ></p>

    <!-- Pesquisa -->
    <section class="max-w-7xl mx-auto px-4 py-6">
      <input
        type="text"
        id="searchInput"
        class="w-full md:w-1/2 border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary"
        placeholder="Pesquisar projetos..."
      />
      <p class="mt-2 text-xs text-gray-500" id="hint">
        Dica: os filtros de Curso/UC ficam disponíveis quando o backend tiver
        endpoints para courses/ucs.
      </p>
    </section>

    <!-- Tipos de curso (opcional / não bloqueia) -->
    <section class="max-w-7xl mx-auto px-4 pb-2">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Tipos de Curso</h2>

      <div class="flex flex-wrap gap-4 mb-6">
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="CTESP"
        >
          CTESP
        </button>
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="Licenciatura"
        >
          Licenciatura
        </button>
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="Mestrado"
        >
          Mestrado
        </button>
        <button
          class="course-btn bg-secondary px-4 py-2 rounded-lg text-gray-900 hover:bg-gray-300 transition"
          data-course="Pos-Graduação"
        >
          Pós-Graduação
        </button>
      </div>

      <!-- Filtros (só ativam se courses/ucs existirem) -->
      <div id="filters" class="flex flex-wrap gap-4 mb-6 hidden">
        <select
          id="yearFilter"
          class="border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary"
        >
          <option value="">Todos os anos</option>
          <option value="1">1º Ano</option>
          <option value="2">2º Ano</option>
          <option value="3">3º Ano</option>
          <option value="4">4º Ano</option>
        </select>

        <select
          id="ucFilter"
          class="border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary"
        >
          <option value="">Todas as UCs</option>
        </select>

        <button
          id="clearFiltersBtn"
          class="bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition"
          type="button"
        >
          Limpar filtros
        </button>
      </div>

      <p id="filtersStatus" class="text-xs text-gray-500 mb-6 hidden"></p>
    </section>

    <!-- Projetos -->
    <section class="max-w-7xl mx-auto px-4 pb-10">
      <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
        <h2 class="text-2xl font-bold text-gray-900">Projetos</h2>
        <p id="resultsInfo" class="text-sm text-gray-600"></p>
      </div>

      <div
        id="projectsList"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
      ></div>
    </section>

    <script>
      // ===== CONFIG =====
      const GRAPHQL_URL = "http://localhost:3000/graphql";

      // ===== AUTH =====
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "null");

      const userInfo = document.getElementById("userInfo");
      const logoutBtn = document.getElementById("logoutBtn");
      const createBtn = document.getElementById("createProjectBtn");

      if (user && user.name) userInfo.textContent = `Olá, ${user.name}`;
      else userInfo.textContent = token ? "Sessão ativa." : "Sem sessão.";

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      });

      // Se não tiver token, escondemos criar + logout e não bloqueamos a página.
      if (!token) {
        createBtn.classList.add("hidden");
        logoutBtn.textContent = "Login";
        logoutBtn.classList.remove("bg-secondary");
        logoutBtn.classList.add("bg-primary", "text-white");
        logoutBtn.addEventListener(
          "click",
          () => (window.location.href = "login.html"),
        );
      } else {
        createBtn.addEventListener(
          "click",
          () => (window.location.href = "upload.html"),
        );
      }

      // ===== DOM =====
      const projectsList = document.getElementById("projectsList");
      const resultsInfo = document.getElementById("resultsInfo");
      const searchInput = document.getElementById("searchInput");
      const courseBtns = document.querySelectorAll(".course-btn");
      const filtersDiv = document.getElementById("filters");
      const filtersStatus = document.getElementById("filtersStatus");
      const yearFilter = document.getElementById("yearFilter");
      const ucFilter = document.getElementById("ucFilter");
      const clearFiltersBtn = document.getElementById("clearFiltersBtn");

      // ===== STATE =====
      let selectedCourseType = "";
      let selectedCourseId = "";
      let selectedYear = "";
      let selectedUcId = "";
      let searchTerm = "";
      let latestCoursesCache = [];
      let backendHasCourses = false;
      let backendHasUcs = false;

      // ===== HELPERS =====
      async function gql(query, variables = {}) {
        const res = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ query, variables }),
        });

        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch {
          console.error("Resposta não-JSON:", text);
          throw new Error("Backend não devolveu JSON (ver consola)");
        }

        if (json.errors?.length) {
          console.error("GraphQL errors:", json.errors);
          throw new Error(json.errors[0].message || "Erro GraphQL");
        }

        return json.data;
      }

      function setLoading(message = "A carregar...") {
        projectsList.innerHTML = `<p class="text-gray-500 col-span-full">${escapeHtml(message)}</p>`;
      }

      function setError(message) {
        projectsList.innerHTML = `
          <div class="col-span-full border border-red-200 bg-red-50 rounded-lg p-4">
            <p class="text-red-700 font-semibold">Erro</p>
            <p class="text-red-700 text-sm mt-1">${escapeHtml(message)}</p>
            <p class="text-red-700 text-xs mt-2">Abre a consola (F12) para ver detalhes.</p>
          </div>
        `;
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderProjects(items, total) {
        projectsList.innerHTML = "";
        resultsInfo.textContent =
          typeof total === "number" ? `${total} resultado(s)` : "";

        if (!items || items.length === 0) {
          projectsList.innerHTML = `<p class="text-gray-500 col-span-full">Nenhum projeto encontrado.</p>`;
          return;
        }

        items.forEach((p) => {
          const card = document.createElement("div");
          card.className =
            "bg-secondary p-4 rounded-lg shadow-md hover:shadow-xl transition cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary";
          card.setAttribute("tabindex", "0");

          const tags = (p.tags || [])
            .slice(0, 6)
            .map((t) => `#${t}`)
            .join(" ");

          card.innerHTML = `
            <h3 class="text-lg font-bold text-primary mb-2">${escapeHtml(p.title)}</h3>
            <p class="text-sm text-gray-700 line-clamp-3 min-h-[3.5rem]">${escapeHtml(p.description || "")}</p>
            <div class="mt-3 text-xs text-gray-700">
              <p><span class="font-semibold">ID:</span> ${escapeHtml(p.id)}</p>
              <p><span class="font-semibold">Criado:</span> ${
                p.createdAt
                  ? new Date(p.createdAt).toLocaleDateString("pt-PT")
                  : "-"
              }</p>
              ${tags ? `<p class="mt-2">${escapeHtml(tags)}</p>` : ""}
            </div>
          `;

          const goToProject = () => {
            window.location.href = `/project.html?id=${encodeURIComponent(p.id)}`;
          };

          card.addEventListener("click", goToProject);
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              goToProject();
            }
          });

          projectsList.appendChild(card);
        });
      }

      // ===== OPTIONAL: COURSES/UCS =====
      async function loadCoursesIfExists() {
        try {
          const data = await gql(`
            query {
              courses { id type name }
            }
          `);
          latestCoursesCache = data?.courses || [];
          backendHasCourses = true;
          return true;
        } catch (e) {
          backendHasCourses = false;
          return false;
        }
      }

      function pickCourseIdByType(type) {
        const candidates = latestCoursesCache.filter((c) => c.type === type);
        return candidates.length ? candidates[0].id : "";
      }

      async function loadUcsForFiltersIfExists() {
        ucFilter.innerHTML = `<option value="">Todas as UCs</option>`;
        selectedUcId = "";
        ucFilter.value = "";

        if (!selectedCourseId) return;

        try {
          const data = await gql(
            `
            query($courseId: ID, $year: Int, $search: String) {
              ucs(courseId: $courseId, year: $year, search: $search) {
                id
                name
                year
              }
            }
            `,
            {
              courseId: selectedCourseId,
              year: selectedYear ? Number(selectedYear) : null,
              search: null,
            },
          );

          backendHasUcs = true;
          const ucs = data?.ucs || [];
          for (const u of ucs) {
            const opt = document.createElement("option");
            opt.value = u.id;
            opt.textContent = `${u.name}${u.year ? ` (Ano ${u.year})` : ""}`;
            ucFilter.appendChild(opt);
          }
        } catch {
          backendHasUcs = false;
        }
      }

      function updateFiltersUI() {
        if (backendHasCourses) {
          filtersStatus.classList.add("hidden");
        } else {
          filtersDiv.classList.add("hidden");
          filtersStatus.classList.remove("hidden");
          filtersStatus.textContent =
            "Filtros de Curso/UC indisponíveis (o backend ainda não tem courses/ucs).";
        }
      }

      // ===== PROJECTS =====
      async function loadProjects() {
        setLoading("A carregar projetos...");

        const filters = {
          search: searchTerm || null,
          courseId: selectedCourseId || null,
          year: selectedYear ? Number(selectedYear) : null,
          ucId: selectedUcId || null,
          tag: null,
        };

        const data = await gql(
          `
          query($filters: ProjectFiltersInput, $page: PaginationInput) {
            projects(filters: $filters, page: $page) {
              total
              items {
                id
                title
                description
                createdAt
                tags
                ucIds
              }
            }
          }
          `,
          { filters, page: { limit: 50, offset: 0 } },
        );

        renderProjects(data.projects.items, data.projects.total);
      }

      // ===== EVENTS =====
      let searchDebounce;
      searchInput.addEventListener("input", (e) => {
        searchTerm = e.target.value;
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
          loadProjects().catch((err) => setError(err.message));
        }, 250);
      });

      courseBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!backendHasCourses) {
            // só faz highlight visual, mas não tenta filtros
            courseBtns.forEach((b) =>
              b.classList.remove("ring-2", "ring-primary"),
            );
            btn.classList.add("ring-2", "ring-primary");
            return;
          }

          selectedCourseType = btn.dataset.course;
          courseBtns.forEach((b) =>
            b.classList.remove("ring-2", "ring-primary"),
          );
          btn.classList.add("ring-2", "ring-primary");

          filtersDiv.classList.remove("hidden");
          selectedCourseId = pickCourseIdByType(selectedCourseType);

          await loadUcsForFiltersIfExists();
          await loadProjects();
        });
      });

      yearFilter.addEventListener("change", async () => {
        selectedYear = yearFilter.value;
        await loadUcsForFiltersIfExists();
        await loadProjects();
      });

      ucFilter.addEventListener("change", async () => {
        selectedUcId = ucFilter.value;
        await loadProjects();
      });

      clearFiltersBtn.addEventListener("click", async () => {
        selectedCourseType = "";
        selectedCourseId = "";
        selectedYear = "";
        selectedUcId = "";

        yearFilter.value = "";
        ucFilter.innerHTML = `<option value="">Todas as UCs</option>`;
        courseBtns.forEach((b) => b.classList.remove("ring-2", "ring-primary"));
        filtersDiv.classList.add("hidden");

        await loadProjects();
      });

      // ===== INIT =====
      (async function init() {
        try {
          await loadCoursesIfExists();
          updateFiltersUI();
          await loadProjects();
        } catch (err) {
          console.error(err);
          setError(err.message || "Erro a carregar projetos");
        }
      })();
    </script>
  </body>
</html>
