<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESMAD Academic Repository - Projetos</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#F05A31",
              secondary: "#BBBCC1",
            },
          },
        },
      };
    </script>

    <style>
      .ring-soft {
        box-shadow: 0 0 0 1px rgba(17, 24, 39, 0.08);
      }
      /* line-clamp via utility fallback (caso não tenhas plugin) */
      .lc-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .lc-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>

  <body class="bg-white font-sans text-gray-900">
    <!-- Top bar (institucional) -->
    <div class="border-b border-gray-100">
      <div
        class="mx-auto max-w-7xl px-4 py-2 flex items-center justify-between text-xs text-gray-600"
      >
        <div class="flex items-center gap-3">
          <span class="inline-flex items-center gap-2">
            <span class="h-2 w-2 rounded-full bg-primary"></span>
            Catálogo de Projetos
          </span>
          <span class="hidden sm:inline text-gray-300">|</span>
          <span class="hidden sm:inline">ESMAD · Politécnico do Porto</span>
        </div>
        <div class="hidden sm:flex items-center gap-4">
          <a href="index.html" class="hover:text-gray-900">Início</a>
          <a href="projects.html" class="hover:text-gray-900 font-semibold"
            >Projetos</a
          >
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <header
      class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-gray-100"
    >
      <nav
        class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between"
      >
        <!-- Brand -->
        <a href="index.html" class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-xl bg-primary/10 ring-soft flex items-center justify-center"
            aria-hidden="true"
          >
            <div class="h-5 w-5 rounded-md bg-primary"></div>
          </div>
          <div class="leading-tight">
            <div class="text-sm font-semibold tracking-wide text-gray-900">
              ESMAD Academic Repository
            </div>
            <div class="text-xs text-gray-500">
              Explorar · Pesquisar · Consultar
            </div>
          </div>
        </a>

        <!-- Actions -->
        <div class="flex items-center gap-3">
          <button
            id="createProjectBtn"
            class="hidden sm:inline-flex items-center justify-center rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:opacity-90 transition"
            type="button"
          >
            Criar novo projeto
          </button>

          <button
            id="logoutBtn"
            class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
            type="button"
          >
            Logout
          </button>
        </div>
      </nav>
    </header>

    <!-- User info -->
    <div class="mx-auto max-w-7xl px-4 pt-4">
      <div
        class="rounded-2xl border border-gray-100 bg-gray-50 p-4 ring-soft flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
      >
        <p id="userInfo" class="text-sm text-gray-700"></p>
        <p class="text-xs text-gray-500">
          Consulta pública disponível. Para interagir/submeter, é necessário
          autenticação.
        </p>
      </div>
    </div>

    <!-- Layout -->
    <main class="mx-auto max-w-7xl px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Sidebar -->
        <aside class="lg:col-span-4">
          <div
            class="rounded-2xl border border-gray-100 bg-white p-6 ring-soft"
          >
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-sm font-semibold text-gray-900">Pesquisa</h2>
                <p class="mt-1 text-sm text-gray-600">
                  Encontra projetos por título, descrição e tags.
                </p>
              </div>
              <div
                class="h-9 w-9 rounded-xl bg-primary/10 flex items-center justify-center"
                aria-hidden="true"
              >
                <div class="h-3 w-3 rounded-sm bg-primary"></div>
              </div>
            </div>

            <div class="mt-4">
              <label
                for="searchInput"
                class="block text-xs font-semibold text-gray-700"
                >Pesquisar</label
              >
              <div class="relative mt-2">
                <input
                  type="text"
                  id="searchInput"
                  class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                  placeholder="Ex.: Web, Arduino, UX, API..."
                />
                <div
                  class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"
                >
                  Enter
                </div>
              </div>

              <p class="mt-2 text-xs text-gray-500" id="hint">
                Dica: filtros de Curso/UC ativam quando o backend expuser
                <span class="font-semibold">courses</span> /
                <span class="font-semibold">ucs</span>.
              </p>
            </div>

            <!-- Tipos de curso -->
            <div class="mt-6 border-t border-gray-100 pt-5">
              <h3 class="text-sm font-semibold text-gray-900">
                Tipos de Curso
              </h3>
              <p class="mt-1 text-xs text-gray-500">
                Seleciona uma tipologia para filtrar.
              </p>

              <div class="mt-4 grid grid-cols-2 gap-3">
                <button
                  class="course-btn rounded-xl px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
                  data-course="CTESP"
                  type="button"
                >
                  CTeSP
                </button>
                <button
                  class="course-btn rounded-xl px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
                  data-course="Licenciatura"
                  type="button"
                >
                  Licenciatura
                </button>
                <button
                  class="course-btn rounded-xl px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
                  data-course="Mestrado"
                  type="button"
                >
                  Mestrado
                </button>
                <button
                  class="course-btn rounded-xl px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition ring-soft"
                  data-course="Pos-Graduação"
                  type="button"
                >
                  Pós-Grad.
                </button>
              </div>

              <!-- Filtros avançados -->
              <div id="filters" class="mt-5 hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label
                      for="yearFilter"
                      class="block text-xs font-semibold text-gray-700"
                      >Ano</label
                    >
                    <select
                      id="yearFilter"
                      class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-3 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                    >
                      <option value="">Todos os anos</option>
                      <option value="1">1º Ano</option>
                      <option value="2">2º Ano</option>
                      <option value="3">3º Ano</option>
                      <option value="4">4º Ano</option>
                    </select>
                  </div>

                  <div>
                    <label
                      for="ucFilter"
                      class="block text-xs font-semibold text-gray-700"
                      >Unidade Curricular</label
                    >
                    <select
                      id="ucFilter"
                      class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-3 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                    >
                      <option value="">Todas as UCs</option>
                    </select>
                  </div>
                </div>

                <button
                  id="clearFiltersBtn"
                  class="mt-4 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition"
                  type="button"
                >
                  Limpar filtros
                </button>
              </div>

              <p
                id="filtersStatus"
                class="mt-4 text-xs text-gray-500 hidden"
              ></p>
            </div>
          </div>
        </aside>

        <!-- Content -->
        <section class="lg:col-span-8">
          <div class="flex items-start justify-between gap-6 flex-wrap">
            <div>
              <h1 class="text-2xl md:text-3xl font-semibold text-gray-900">
                Projetos
              </h1>
              <p class="mt-2 text-sm text-gray-600">
                Resultados disponíveis no catálogo institucional.
              </p>
            </div>

            <div
              class="rounded-xl border border-gray-100 bg-white px-4 py-3 ring-soft"
            >
              <p id="resultsInfo" class="text-sm text-gray-700"></p>
              <p id="activeFilters" class="text-xs text-gray-500 mt-1"></p>
            </div>
          </div>

          <!-- List -->
          <div class="mt-6">
            <div
              id="projectsList"
              class="grid grid-cols-1 sm:grid-cols-2 gap-5"
            ></div>
          </div>

          <!-- Footer note -->
          <div class="mt-8 text-xs text-gray-500">
            Sugestão: abre um projeto para ver anexos e detalhes (login pode ser
            necessário).
          </div>
        </section>
      </div>
    </main>

    <!-- Script -->
    <script>
      // ===== CONFIG =====
      const GRAPHQL_URL = "http://localhost:3000/graphql";

      // ===== AUTH =====
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "null");

      const userInfo = document.getElementById("userInfo");
      const logoutBtn = document.getElementById("logoutBtn");
      const createBtn = document.getElementById("createProjectBtn");

      if (user && user.name)
        userInfo.textContent = `Sessão ativa: ${user.name}`;
      else
        userInfo.textContent = token
          ? "Sessão ativa."
          : "Sem sessão (consulta pública).";

      // Logout/Login
      logoutBtn.addEventListener("click", () => {
        if (!token) {
          window.location.href = "login.html";
          return;
        }
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      });

      // Se não tiver token: esconde "criar", transforma botão em "Login"
      if (!token) {
        createBtn.classList.add("hidden");
        logoutBtn.textContent = "Login";
        logoutBtn.classList.remove(
          "text-gray-700",
          "ring-soft",
          "hover:bg-gray-50",
        );
        logoutBtn.classList.add("bg-primary", "text-white", "hover:opacity-90");
      } else {
        createBtn.classList.remove("hidden");
        createBtn.addEventListener(
          "click",
          () => (window.location.href = "upload.html"),
        );
      }

      // ===== DOM =====
      const projectsList = document.getElementById("projectsList");
      const resultsInfo = document.getElementById("resultsInfo");
      const activeFilters = document.getElementById("activeFilters");
      const searchInput = document.getElementById("searchInput");
      const courseBtns = document.querySelectorAll(".course-btn");
      const filtersDiv = document.getElementById("filters");
      const filtersStatus = document.getElementById("filtersStatus");
      const yearFilter = document.getElementById("yearFilter");
      const ucFilter = document.getElementById("ucFilter");
      const clearFiltersBtn = document.getElementById("clearFiltersBtn");

      // ===== STATE =====
      let selectedCourseType = "";
      let selectedCourseId = "";
      let selectedYear = "";
      let selectedUcId = "";
      let searchTerm = "";
      let latestCoursesCache = [];
      let backendHasCourses = false;
      let backendHasUcs = false;

      // ===== HELPERS =====
      async function gql(query, variables = {}) {
        const res = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ query, variables }),
        });

        const text = await res.text().catch(() => "");
        let json;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          console.error("Resposta não-JSON:", res.status, text);
          throw new Error(`Backend não devolveu JSON (HTTP ${res.status})`);
        }

        if (!res.ok) {
          console.error("HTTP error:", res.status, json);
          const msg =
            json?.errors?.[0]?.message ||
            json?.message ||
            json?.error ||
            text ||
            `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (json?.errors?.length) {
          console.error("GraphQL errors:", json.errors);
          throw new Error(json.errors[0].message || "Erro GraphQL");
        }

        return json.data;
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function setLoading(message = "A carregar...") {
        projectsList.innerHTML = `
          <div class="col-span-full rounded-2xl border border-gray-100 bg-white p-6 ring-soft">
            <div class="animate-pulse space-y-3">
              <div class="h-4 w-1/3 rounded bg-gray-100"></div>
              <div class="h-3 w-full rounded bg-gray-100"></div>
              <div class="h-3 w-5/6 rounded bg-gray-100"></div>
              <div class="h-8 w-28 rounded bg-gray-100"></div>
            </div>
            <p class="mt-4 text-sm text-gray-600">${escapeHtml(message)}</p>
          </div>
        `;
      }

      function setError(message) {
        projectsList.innerHTML = `
          <div class="col-span-full rounded-2xl border border-red-200 bg-red-50 p-6">
            <p class="text-red-800 font-semibold">Erro ao carregar</p>
            <p class="text-red-700 text-sm mt-1">${escapeHtml(message)}</p>
            <p class="text-red-700 text-xs mt-3">Abre a consola (F12) para detalhes.</p>
          </div>
        `;
      }

      function badge(text) {
        return `<span class="inline-flex items-center rounded-full border border-gray-200 bg-white px-2.5 py-1 text-xs font-semibold text-gray-700">${escapeHtml(
          text,
        )}</span>`;
      }

      function renderActiveFilters(total) {
        const parts = [];
        if (searchTerm.trim()) parts.push(`Pesquisa: "${searchTerm.trim()}"`);
        if (selectedCourseType) parts.push(`Tipo: ${selectedCourseType}`);
        if (selectedYear) parts.push(`Ano: ${selectedYear}`);
        if (selectedUcId) parts.push(`UC: selecionada`);
        activeFilters.textContent = parts.length
          ? parts.join(" · ")
          : "Sem filtros ativos";

        resultsInfo.textContent =
          typeof total === "number" ? `${total} resultado(s)` : "";
      }

      function renderProjects(items, total) {
        projectsList.innerHTML = "";
        renderActiveFilters(total);

        if (!items || items.length === 0) {
          projectsList.innerHTML = `
            <div class="col-span-full rounded-2xl border border-gray-100 bg-white p-8 ring-soft">
              <p class="text-gray-900 font-semibold">Nenhum projeto encontrado</p>
              <p class="mt-1 text-sm text-gray-600">
                Tenta ajustar a pesquisa ou remover filtros.
              </p>
              <button id="emptyClearBtn" class="mt-4 rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition" type="button">
                Limpar filtros
              </button>
            </div>
          `;
          document
            .getElementById("emptyClearBtn")
            ?.addEventListener("click", () => {
              clearFiltersBtn.click();
              searchInput.value = "";
              searchTerm = "";
              loadProjects().catch((err) => setError(err.message));
            });
          return;
        }

        items.forEach((p) => {
          const card = document.createElement("article");
          card.className =
            "rounded-2xl border border-gray-100 bg-white p-6 ring-soft hover:shadow-sm hover:border-gray-200 transition cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary/20";
          card.setAttribute("tabindex", "0");

          const created = p.createdAt
            ? new Date(p.createdAt).toLocaleDateString("pt-PT")
            : "-";

          const tags = (p.tags || []).slice(0, 6);

          card.innerHTML = `
            <div class="flex items-start justify-between gap-4">
              <div class="min-w-0">
                <h3 class="text-base md:text-lg font-semibold text-gray-900 lc-2">
                  ${escapeHtml(p.title || "Sem título")}
                </h3>
                <p class="mt-2 text-sm text-gray-600 lc-3">
                  ${escapeHtml(p.description || "Sem descrição.")}
                </p>
              </div>

              <div class="shrink-0 h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center" aria-hidden="true">
                <div class="h-3 w-3 rounded-sm bg-primary"></div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              ${badge(`ID: ${p.id}`)}
              ${badge(`Criado: ${created}`)}
              ${Array.isArray(p.ucIds) && p.ucIds.length ? badge(`UCs: ${p.ucIds.length}`) : ""}
            </div>

            ${
              tags.length
                ? `<div class="mt-4 flex flex-wrap gap-2">
                     ${tags.map((t) => badge("#" + t)).join("")}
                   </div>`
                : ""
            }

            <div class="mt-5 flex items-center justify-between">
              <span class="text-xs text-gray-500">Abrir detalhes</span>
              <span class="text-sm font-semibold text-primary">Ver →</span>
            </div>
          `;

          const goToProject = () => {
            window.location.href = `/project.html?id=${encodeURIComponent(p.id)}`;
          };

          card.addEventListener("click", goToProject);
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              goToProject();
            }
          });

          projectsList.appendChild(card);
        });
      }

      // ===== OPTIONAL: COURSES/UCS =====
      async function loadCoursesIfExists() {
        try {
          const data = await gql(`
            query {
              courses { id type name }
            }
          `);
          latestCoursesCache = data?.courses || [];
          backendHasCourses = true;
          return true;
        } catch {
          backendHasCourses = false;
          return false;
        }
      }

      function pickCourseIdByType(type) {
        const candidates = latestCoursesCache.filter((c) => c.type === type);
        return candidates.length ? candidates[0].id : "";
      }

      async function loadUcsForFiltersIfExists() {
        ucFilter.innerHTML = `<option value="">Todas as UCs</option>`;
        selectedUcId = "";
        ucFilter.value = "";

        if (!selectedCourseId) return;

        try {
          const data = await gql(
            `
            query($courseId: ID, $year: Int, $search: String) {
              ucs(courseId: $courseId, year: $year, search: $search) {
                id
                name
                year
              }
            }
            `,
            {
              courseId: selectedCourseId,
              year: selectedYear ? Number(selectedYear) : null,
              search: null,
            },
          );

          backendHasUcs = true;
          const ucs = data?.ucs || [];
          for (const u of ucs) {
            const opt = document.createElement("option");
            opt.value = u.id;
            opt.textContent = `${u.name}${u.year ? ` (Ano ${u.year})` : ""}`;
            ucFilter.appendChild(opt);
          }
        } catch {
          backendHasUcs = false;
        }
      }

      function updateFiltersUI() {
        if (backendHasCourses) {
          filtersDiv.classList.add("hidden"); // só aparece depois de selecionar tipo
          filtersStatus.classList.add("hidden");
        } else {
          filtersDiv.classList.add("hidden");
          filtersStatus.classList.remove("hidden");
          filtersStatus.textContent =
            "Filtros de Curso/UC indisponíveis (o backend ainda não tem courses/ucs).";
        }
      }

      function highlightCourse(btn) {
        courseBtns.forEach((b) => {
          b.classList.remove("ring-2", "ring-primary");
          b.classList.add("ring-soft");
        });
        btn.classList.add("ring-2", "ring-primary");
      }

      // ===== PROJECTS =====
      async function loadProjects() {
        setLoading("A carregar projetos...");

        const filters = {
          search: searchTerm || null,
          courseId: selectedCourseId || null,
          year: selectedYear ? Number(selectedYear) : null,
          ucId: selectedUcId || null,
          tag: null,
        };

        const data = await gql(
          `
          query($filters: ProjectFiltersInput, $page: PaginationInput) {
            projects(filters: $filters, page: $page) {
              total
              items {
                id
                title
                description
                createdAt
                tags
                ucIds
              }
            }
          }
          `,
          { filters, page: { limit: 50, offset: 0 } },
        );

        if (!data?.projects)
          throw new Error("Resposta inválida do backend: falta 'projects'");

        renderProjects(data.projects.items, data.projects.total);
      }

      // ===== EVENTS =====
      let searchDebounce;

      // Suporte a ?q= e ?type= (vindo do index)
      function readQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const q = params.get("q");
        const type = params.get("type");
        if (q) {
          searchTerm = q;
          searchInput.value = q;
        }
        if (type) {
          selectedCourseType = type;
        }
      }

      searchInput.addEventListener("input", (e) => {
        searchTerm = e.target.value;
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
          loadProjects().catch((err) => setError(err.message));
        }, 250);
      });

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          loadProjects().catch((err) => setError(err.message));
        }
      });

      courseBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          highlightCourse(btn);

          if (!backendHasCourses) return;

          selectedCourseType = btn.dataset.course;
          filtersDiv.classList.remove("hidden");

          selectedCourseId = pickCourseIdByType(selectedCourseType);
          await loadUcsForFiltersIfExists();
          await loadProjects();
        });
      });

      yearFilter.addEventListener("change", async () => {
        selectedYear = yearFilter.value;
        await loadUcsForFiltersIfExists();
        await loadProjects();
      });

      ucFilter.addEventListener("change", async () => {
        selectedUcId = ucFilter.value;
        await loadProjects();
      });

      clearFiltersBtn.addEventListener("click", async () => {
        selectedCourseType = "";
        selectedCourseId = "";
        selectedYear = "";
        selectedUcId = "";

        yearFilter.value = "";
        ucFilter.innerHTML = `<option value="">Todas as UCs</option>`;
        courseBtns.forEach((b) => b.classList.remove("ring-2", "ring-primary"));
        filtersDiv.classList.add("hidden");

        await loadProjects();
      });

      // ===== INIT =====
      (async function init() {
        try {
          readQueryParams();
          await loadCoursesIfExists();
          updateFiltersUI();

          // Se vier type do URL e o backend suportar, ativa logo
          if (selectedCourseType && backendHasCourses) {
            const btn = [...courseBtns].find(
              (b) => b.dataset.course === selectedCourseType,
            );
            if (btn) {
              highlightCourse(btn);
              filtersDiv.classList.remove("hidden");
              selectedCourseId = pickCourseIdByType(selectedCourseType);
              await loadUcsForFiltersIfExists();
            }
          }

          await loadProjects();
        } catch (err) {
          console.error(err);
          setError(err.message || "Erro a carregar projetos");
        }
      })();
    </script>
  </body>
</html>
