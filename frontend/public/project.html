<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Projeto</title>
    <style>
      body {
        font-family: system-ui, Arial;
        background: #fff;
        margin: 0;
      }
      header {
        padding: 16px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      main {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .card {
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.04);
      }
      .meta {
        color: #666;
        font-size: 13px;
        margin-top: 6px;
      }
      .actions {
        display: flex;
        gap: 10px;
        margin-top: 14px;
        flex-wrap: wrap;
      }
      button,
      a.btn {
        padding: 10px 14px;
        border: 0;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .primary {
        background: #f05a31;
        color: white;
      }
      .ghost {
        background: #eee;
        color: #111;
      }
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #bbbcc1;
        font-size: 12px;
      }
      .status {
        margin-top: 12px;
        font-size: 13px;
        color: #333;
        white-space: pre-wrap;
      }
      pre {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 12px;
        overflow: auto;
      }

      /* ✅ Toast / Alert */
      .toast-wrap {
        position: fixed;
        right: 18px;
        bottom: 18px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        width: min(420px, calc(100vw - 36px));
        border-radius: 14px;
        padding: 12px 12px 10px;
        background: #111;
        color: #fff;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .toast .top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
      }
      .toast .title {
        font-weight: 700;
        font-size: 14px;
        margin: 0;
      }
      .toast .close {
        background: transparent;
        color: #fff;
        border: 0;
        font-size: 18px;
        line-height: 18px;
        cursor: pointer;
        padding: 4px 6px;
        opacity: 0.9;
      }
      .toast .msg {
        margin: 8px 0 0;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.92);
        white-space: pre-wrap;
      }
      .toast .meta2 {
        margin-top: 8px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }
      .toast .btnrow {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .toast .btnsmall {
        padding: 8px 10px;
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        font-size: 13px;
      }
      .toast .btnok {
        background: #f05a31;
        color: #fff;
      }
      .toast .btnghost {
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <strong>ESMAD Archive</strong> <span class="pill">Projeto</span>
      </div>
      <a class="btn ghost" href="projects.html">← Voltar</a>
    </header>

    <main>
      <div class="card">
        <h1 id="title" style="margin: 0">(a carregar...)</h1>
        <div class="meta" id="meta"></div>

        <p id="description" style="margin-top: 12px; white-space: pre-wrap"></p>

        <div class="actions">
          <button class="primary" id="downloadBtn" disabled>Download</button>

          <a
            class="btn ghost"
            id="repoBtn"
            href="#"
            target="_blank"
            rel="noreferrer"
            style="display: none"
            >Repo</a
          >
          <a
            class="btn ghost"
            id="demoBtn"
            href="#"
            target="_blank"
            rel="noreferrer"
            style="display: none"
            >Demo</a
          >
        </div>

        <div class="status" id="status"></div>

        <details style="margin-top: 14px">
          <summary>Debug (JSON)</summary>
          <pre id="debug"></pre>
        </details>
      </div>
    </main>

    <!-- ✅ Toast container -->
    <div class="toast-wrap" id="toastWrap"></div>

    <script>
      const API_BASE = window.location.origin; // força porta correta (ex: http://localhost:8080)
      const GRAPHQL_URL = `${API_BASE}/graphql`;
      console.log("[DEBUG] API_BASE =", API_BASE);

      function setStatus(msg) {
        document.getElementById("status").textContent = msg || "";
      }

      function getToken() {
        return localStorage.getItem("token");
      }

      // ✅ devolve Int (e valida)
      function getProjectIdInt() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get("id");
        const id = Number(raw);
        if (!raw || !Number.isFinite(id)) return { raw, id: null };
        return { raw, id };
      }

      async function gql(query, variables = {}) {
        const token = getToken();
        const res = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ query, variables }),
        });

        const text = await res.text().catch(() => "");
        let json;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          console.error("Resposta não-JSON:", res.status, text);
          throw new Error(`Backend não devolveu JSON (HTTP ${res.status})`);
        }

        if (!res.ok) {
          console.error("HTTP error:", res.status, json);
          const msg =
            json?.errors?.[0]?.message ||
            json?.message ||
            json?.error ||
            text ||
            `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (json?.errors?.length) {
          console.error("GraphQL errors:", json.errors);
          throw new Error(json.errors[0].message || "Erro GraphQL");
        }

        return json.data;
      }

      async function fetchProject(id) {
        const data = await gql(
          `
          query ($id: Int!) {
            project(id: $id) {
              id
              title
              description
              repoUrl
              demoUrl
              createdAt
              fileId
            }
          }
        `,
          { id },
        );
        return data.project;
      }

      async function fetchDownloadUrl(fileId) {
        const token = getToken();
        if (!token) throw new Error("Faz login para descarregar.");

        const res = await fetch(
          `${API_BASE}/files/${encodeURIComponent(fileId)}/download`,
          {
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
          },
        );

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(
            `Erro no download (${res.status}): ${txt || "sem detalhe"}`,
          );
        }

        const json = await res.json();
        if (!json.downloadUrl)
          throw new Error("Resposta inválida: falta downloadUrl");

        return json.downloadUrl;
      }

      // =========================================================
      // ✅ NOTIFICATIONS (ALERTA)
      // =========================================================

      const toastWrap = document.getElementById("toastWrap");
      let notifTimer = null;
      let lastShownNotificationId = null;

      function safeDate(v) {
        try {
          const d = new Date(v);
          if (Number.isNaN(d.getTime())) return "";
          return d.toLocaleString("pt-PT");
        } catch {
          return "";
        }
      }

      function pickMessage(n) {
        // tenta vários nomes (para ser compatível com diferentes schemas)
        return (
          n.message ||
          n.text ||
          n.title ||
          n.body ||
          n.type ||
          n.event ||
          `Tens uma nova notificação (id=${n.id})`
        );
      }

      function removeToast(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      async function markNotificationRead(id) {
        const token = getToken();
        if (!token) return;

        try {
          const res = await fetch(`/notifications/${id}/read`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });
          if (!res.ok) {
            const t = await res.text().catch(() => "");
            console.warn("mark read failed:", res.status, t);
          }
        } catch (e) {
          console.warn("mark read error:", e);
        }
      }

      function showToastForNotification(n) {
        if (!n || !n.id) return;

        // ✅ evita repetir o mesmo alerta
        if (String(n.id) === String(lastShownNotificationId)) return;
        lastShownNotificationId = String(n.id);

        const toastId = `toast_${n.id}`;
        const createdAt =
          n.createdAt || n.created_at || n.at || n.timestamp || null;

        const msg = pickMessage(n);

        const el = document.createElement("div");
        el.className = "toast";
        el.id = toastId;

        el.innerHTML = `
          <div class="top">
            <div>
              <p class="title">Nova notificação ✅</p>
              <div class="msg">${escapeHtml(msg)}</div>
              <div class="meta2">
                <span>${createdAt ? safeDate(createdAt) : ""}</span>
                <span>#${escapeHtml(String(n.id))}</span>
              </div>
              <div class="btnrow">
                <button class="btnsmall btnghost" data-action="dismiss">Ignorar</button>
                <button class="btnsmall btnok" data-action="ok">OK</button>
              </div>
            </div>
            <button class="close" aria-label="Fechar" data-action="close">×</button>
          </div>
        `;

        el.addEventListener("click", async (ev) => {
          const btn = ev.target?.closest?.("[data-action]");
          if (!btn) return;
          const action = btn.getAttribute("data-action");

          // em qualquer caso, removemos o toast
          removeToast(toastId);

          // ✅ marca como lida ao fechar/ok/ignorar
          await markNotificationRead(n.id);
        });

        toastWrap.appendChild(el);

        // auto-remove após 7s + marca lida também
        setTimeout(async () => {
          const stillThere = document.getElementById(toastId);
          if (stillThere) {
            stillThere.remove();
            await markNotificationRead(n.id);
          }
        }, 7000);
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function fetchUnreadNotifications(limit = 1) {
        const token = getToken();
        if (!token) return [];

        // ✅ URL RELATIVO: vai sempre ao mesmo origin (http://localhost:8080)
        const url = `/notifications/?unread=true&limit=${encodeURIComponent(limit)}&offset=0`;

        const res = await fetch(url, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) {
          const t = await res.text().catch(() => "");
          console.warn("notifications fetch failed:", res.status, t);
          return [];
        }

        const json = await res.json().catch(() => null);

        // suporta backend a devolver array direto OU objeto com items
        if (Array.isArray(json)) return json;

        const items =
          json?.items ||
          json?.data ||
          json?.notifications ||
          json?.rows ||
          json?.result;

        return Array.isArray(items) ? items : [];
      }

      async function checkNotificationsOnce() {
        try {
          const items = await fetchUnreadNotifications(1);
          if (items.length > 0) {
            showToastForNotification(items[0]);
          }
        } catch (e) {
          console.warn("checkNotificationsOnce error:", e);
        }
      }

      function startNotificationsPolling() {
        // dispara logo
        checkNotificationsOnce();

        // polling
        if (notifTimer) clearInterval(notifTimer);
        notifTimer = setInterval(checkNotificationsOnce, 3000);
      }

      // =========================================================

      document.addEventListener("DOMContentLoaded", async () => {
        const { raw, id } = getProjectIdInt();
        if (!id) {
          setStatus(`Falta ?id=... (valor atual: ${raw || "null"})`);
          return;
        }

        const downloadBtn = document.getElementById("downloadBtn");
        downloadBtn.disabled = true;

        // ✅ começa polling de notificações (só mostra se houver token e unread)
        startNotificationsPolling();

        try {
          const p = await fetchProject(id);
          if (!p) {
            setStatus("Projeto não encontrado.");
            return;
          }

          document.getElementById("title").textContent = p.title;
          document.getElementById("description").textContent =
            p.description || "";
          document.getElementById("meta").textContent =
            `ID: ${p.id} • Criado: ${p.createdAt ? new Date(p.createdAt).toLocaleString("pt-PT") : "-"}`;

          document.getElementById("debug").textContent = JSON.stringify(
            { urlIdRaw: raw, urlIdInt: id, project: p },
            null,
            2,
          );

          if (p.repoUrl) {
            const btn = document.getElementById("repoBtn");
            btn.href = p.repoUrl;
            btn.style.display = "inline-flex";
          }
          if (p.demoUrl) {
            const btn = document.getElementById("demoBtn");
            btn.href = p.demoUrl;
            btn.style.display = "inline-flex";
          }

          if (!p.fileId) {
            downloadBtn.disabled = true;
            downloadBtn.textContent = "Sem ficheiro";
            setStatus("Este projeto não tem ficheiro associado.");
            return;
          }

          downloadBtn.disabled = false;
          downloadBtn.textContent = "Download";

          downloadBtn.addEventListener("click", async () => {
            try {
              setStatus("A gerar link de download...");
              downloadBtn.disabled = true;

              const url = await fetchDownloadUrl(p.fileId);

              setStatus("A abrir download...");
              window.open(url, "_blank", "noopener,noreferrer");
            } catch (e) {
              console.error(e);
              setStatus(e.message || "Erro ao descarregar");
            } finally {
              downloadBtn.disabled = false;
            }
          });

          setStatus("Pronto.");
        } catch (err) {
          console.error(err);
          setStatus(err.message || "Erro a carregar projeto");
        }
      });
    </script>
  </body>
</html>
